<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <title>Essam Support â€¢ Admin</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
        <div class="small" id="who"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnEnableNotifs">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
      <button class="btn danger" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Pending)</div>
      <div class="small">ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ø¶ØºØ· Ù‚Ø¨ÙˆÙ„ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©.</div>
      <hr/>
      <div class="list" id="reqList"></div>
    </div>

    <div class="card">
      <div class="title">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†)</div>
      <div class="small">ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©). ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯.</div>
      <hr/>
      <div class="list" id="globalMsgs"></div>
      <hr/>
      <div class="row">
        <input class="input" id="reqIdForMsgs" placeholder="Request ID" />
        <button class="btn" id="btnLoadMsgs">Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
      <div class="chatlog" id="msgsBox" style="height:240px; margin-top:12px"></div>
    </div>
  </div>

  <div class="footer">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØª/ÙÙŠØ¯ÙŠÙˆ ÙŠØªÙ… Ø¹Ø¨Ø± PeerJS. Ù„Ùˆ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø´Ø¨ÙƒØ© Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯ÙˆÙ† VPN.</div>
</div>

<script type="module">
  import { requireAuth, logout } from "./assets/auth.js";
  import { isAdmin, listenPendingRequests, acceptRequest, rejectRequest, listenOfflineMessagesForRequest, listenGlobalMessages } from "./assets/db.js";
  import { toast } from "./assets/ui.js";
  import { initMessaging, wireNotificationButton } from "./assets/notifications.js";

  const who = document.getElementById("who");
  const reqList = document.getElementById("reqList");
  const btnLogout = document.getElementById("btnLogout");

  const reqIdForMsgs = document.getElementById("reqIdForMsgs");
  const btnLoadMsgs = document.getElementById("btnLoadMsgs");
  const msgsBox = document.getElementById("msgsBox");
  const globalMsgs = document.getElementById("globalMsgs");

  let unsubMsgs = null;

  const user = await requireAuth("index.html");

  const admin = await isAdmin(user.uid, user.email || "");
  if(!admin){
    toast("ØºÙŠØ± Ù…ØµØ±Ø­", "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ù…Ø¯ÙŠØ±Ø§Ù‹.");
    location.replace("index.html");
  }

  who.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName || user.email || user.uid}`;

  await initMessaging();
  wireNotificationButton("#btnEnableNotifs");

  btnLogout.addEventListener("click", async ()=>{
    await logout();
    location.replace("index.html");
  });

  function renderMsgs(reqId){
    if(!reqId) return;
    reqIdForMsgs.value = reqId;

    msgsBox.innerHTML = "";
    if(unsubMsgs) try{ unsubMsgs(); }catch{}
    unsubMsgs = listenOfflineMessagesForRequest(reqId, (msgs)=>{
      msgsBox.innerHTML = msgs.map(m=> `
        <div class="msg">
          <div class="who">${m.fromName || m.fromUid || "unknown"} â€¢ ${new Date(m.createdAt||Date.now()).toLocaleString()}</div>
          <div>${String(m.text||"").replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
        </div>
      `).join("") || '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.</div>';
      msgsBox.scrollTop = msgsBox.scrollHeight;
    });
  }

  // âœ… Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø© ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ (Ø²ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
  listenGlobalMessages((items)=>{
    if(!items.length){
      globalMsgs.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯.</div>';
      return;
    }
    globalMsgs.innerHTML = items.slice(0, 20).map(m=>`
      <div class="item">
        <div class="meta">
          <div class="title">${(m.name||"Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…").replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
          <div class="sub">${(m.type||"")} â€¢ ${(m.contact||"")} â€¢ ${new Date(m.timestamp||Date.now()).toLocaleString()}</div>
          <div class="sub">${String(m.content||"").slice(0,200).replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
          ${m.reqId ? `<div class="sub">Request: <b>${m.reqId}</b></div>` : ``}
        </div>
        <div class="row">
          ${m.reqId ? `<button class="btn" data-req="${m.reqId}">ÙØªØ­</button>` : ``}
        </div>
      </div>
    `).join("");

    globalMsgs.querySelectorAll("button[data-req]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-req");
        renderMsgs(id);
      });
    });
  });

  btnLoadMsgs.addEventListener("click", ()=>{
    const id = (reqIdForMsgs.value||"").trim();
    if(!id) return;
    renderMsgs(id);
  });

  function render(items){
    reqList.innerHTML = "";
    if(!items.length){
      reqList.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø§Ù„Ø¢Ù†.</div>';
      return;
    }

    for(const r of items){
      const name = (r.displayName || r.email || r.createdByUid || "â€”");
      const hasOffline = (r.lastOfflineAt && r.lastOfflineAt > 0);

      const el = document.createElement("div");
      el.className="item";
      el.innerHTML = `
        <div class="meta">
          <div class="title">Ø·Ù„Ø¨ #${r.id}</div>
          <div class="sub">${r.createdByType} â€¢ ${name} â€¢ ${r.phone || "â€”"}</div>
          <div class="sub">${(r.note||"").slice(0,120)}</div>
          ${hasOffline ? `<div class="sub" style="color:#ffd18b">ğŸ“© Ø£ÙˆÙÙ„Ø§ÙŠÙ†: ${r.lastOfflineFrom || ""} â€” ${(r.lastOfflineText||"")}</div>` : ``}
        </div>
        <div class="row">
          <button class="btn" data-act="msgs">Ø±Ø³Ø§Ø¦Ù„</button>
          <button class="btn ok" data-act="accept">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn danger" data-act="reject">Ø±ÙØ¶</button>
        </div>
      `;

      el.querySelector('[data-act="msgs"]').addEventListener("click", ()=>{
        renderMsgs(r.id);
      });

      el.querySelector('[data-act="accept"]').addEventListener("click", async ()=>{
        try{
          const { roomId, token } = await acceptRequest({ reqId: r.id, adminUid: user.uid });
          toast("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„", "Ø³ÙŠØªÙ… ÙØªØ­ ØºØ±ÙØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¢Ù†.");
          window.open(`video.html?room=${encodeURIComponent(roomId)}&token=${encodeURIComponent(token)}`, "_blank");
        }catch(e){
          console.error(e);
          toast("ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„", e?.message || "");
        }
      });

      el.querySelector('[data-act="reject"]').addEventListener("click", async ()=>{
        try{
          await rejectRequest({ reqId: r.id, adminUid: user.uid });
          toast("ØªÙ… Ø§Ù„Ø±ÙØ¶", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.");
        }catch(e){
          console.error(e);
          toast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶", e?.message || "");
        }
      });

      reqList.appendChild(el);
    }
  }

  listenPendingRequests(render);
</script>
</body>
</html>

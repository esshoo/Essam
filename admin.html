<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <title>Essam Support â€¢ Admin</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
        <div class="small" id="who"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnEnableNotifs">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
      <button class="btn danger" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Pending)</div>
      <div class="small">ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ø¶ØºØ· Ù‚Ø¨ÙˆÙ„ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©.</div>
      <hr/>
      <div class="list" id="reqList"></div>
    </div>

    <div class="card">
      <div class="title">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†)</div>
      <div class="small">ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø«Ù… (Ø±Ø¯) Ø£Ùˆ (ØªÙØ±ÙŠØº).</div>
      <hr/>
      <div class="row" style="align-items:flex-start; gap:12px">
        <div style="flex:1; min-width:260px">
          <div class="small">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯</div>
          <div class="list" id="offlineThreads"></div>
        </div>
        <div style="flex:1; min-width:260px">
          <div class="small">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
          <div class="chatlog" id="msgsBox" style="height:240px; margin-top:8px"></div>
          <div class="row" style="margin-top:10px">
            <input class="input" id="replyText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ù‹Ø§ Ù„Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ø¶ÙŠÙ..." />
            <button class="btn" id="btnSendReply">Ø±Ø¯</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn danger" id="btnClearThread">ØªÙØ±ÙŠØº/Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØª/ÙÙŠØ¯ÙŠÙˆ ÙŠØªÙ… Ø¹Ø¨Ø± PeerJS. Ù„Ùˆ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø´Ø¨ÙƒØ© Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯ÙˆÙ† VPN.</div>
</div>

<script type="module">
  import { requireAuth, logout } from "./assets/auth.js";
  import {
    isAdmin,
    listenAllRequests,
    acceptRequest,
    rejectRequest,
    listenOfflineMessagesForRequest,
    listenOfflineThreadsAdmin,
    clearOfflineMessagesAsAdmin,
    deleteOfflineMessageAsAdmin,
    sendAdminReply,
    banUser
  } from "./assets/db.js";
  import { toast, fmtTime, escapeHtml } from "./assets/ui.js";
  import { initMessaging, wireNotificationButton, notifyLocal } from "./assets/notifications.js";
  import { primeAudio, ring, beep, pop, errorBeep } from "./assets/sounds.js";

  const who = document.getElementById("who");
  const reqList = document.getElementById("reqList");
  const btnLogout = document.getElementById("btnLogout");

  const offlineThreads = document.getElementById("offlineThreads");
  const msgsBox = document.getElementById("msgsBox");
  const replyText = document.getElementById("replyText");
  const btnSendReply = document.getElementById("btnSendReply");
  const btnClearThread = document.getElementById("btnClearThread");

  let selectedReqId = "";
  let unsubThreadMsgs = null;

  // Prime audio on first gesture so tones can play.
  window.addEventListener("pointerdown", () => primeAudio(), { once:true });

  // Auth + admin check
  const user = await requireAuth("index.html");
  const adminOk = await isAdmin(user.uid, user.email || "");
  if (!adminOk) {
    toast("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©", "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±");
    location.replace("index.html");
    throw new Error("Not admin");
  }

  who.textContent = `Admin: ${user.email || user.uid}`;
  btnLogout.addEventListener("click", async () => {
    await logout();
    location.replace("index.html");
  });

  // Notifications button (FCM token)
  try { await initMessaging(); } catch {}
  wireNotificationButton("#btnEnableNotifs");

  // ---------- Pending requests ----------
  let seenPending = new Set();
  let stopRing = null;

  function renderPending(items){
    reqList.innerHTML = "";
    if(!items.length){
      reqList.innerHTML = `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¢Ù†.</div>`;
      return;
    }

    for(const r of items){
      const name = r.displayName || r.email || r.phone || r.createdByUid;
      const meta = [
        r.email ? `ğŸ“§ ${r.email}` : "",
        r.phone ? `ğŸ“ ${r.phone}` : "",
        r.note ? `ğŸ“ ${escapeHtml(r.note)}` : ""
      ].filter(Boolean).join(" â€¢ ");

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div><b>${escapeHtml(name)}</b></div>
          <div class="small">${meta || ""}</div>
          <div class="small">${fmtTime(r.createdAt || 0)} â€¢ ${escapeHtml(r.id)}</div>
        </div>
        <div class="row">
          <button class="btn" data-act="accept" data-id="${r.id}">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn danger" data-act="reject" data-id="${r.id}">Ø±ÙØ¶</button>
          <button class="btn danger" data-act="ban" data-uid="${r.createdByUid||""}">Ø­Ø¸Ø±</button>
        </div>
      `;
      reqList.appendChild(el);
    }

    reqList.querySelectorAll("button[data-act]").forEach((b)=>{
      b.addEventListener("click", async ()=>{
        const act = b.dataset.act;
        const id = b.dataset.id;
        b.disabled = true;
        try{
          await primeAudio();
          if(act === "ban"){
            const uid = b.dataset.uid;
            if(!uid) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ UID Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
            await banUser({ uid, adminUid: user.uid, reason: "manual" });
            toast("ØªÙ… Ø§Ù„Ø­Ø¸Ø±", "ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ù„Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§Øª/Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©.");
            errorBeep();
            return;
          }

          if(act === "accept"){
            pop();
            const { token } = await acceptRequest({ reqId: id, adminUid: user.uid });
            toast("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„", "Ø³ÙŠØªÙ… ÙØªØ­ ØºØ±ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„");
            // Jump into room
            location.href = `video.html?room=${encodeURIComponent(id)}&token=${encodeURIComponent(token)}`;
          }else{
            errorBeep();
            await rejectRequest({ reqId: id, adminUid: user.uid });
            toast("ØªÙ… Ø§Ù„Ø±ÙØ¶", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨");
          }
        }catch(e){
          console.error(e);
          toast("Ø®Ø·Ø£", e?.message || "ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
          b.disabled = false;
        }
      });
    });
  }

  let requestMap = new Map();

  listenAllRequests((all)=>{
    requestMap = new Map(all.map(r=>[r.id, r]));

    // âœ… Ø¹Ø±Ø¶ *ÙƒÙ„* Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø© (Ø¨Ø¯ÙˆÙ† Ø¯Ù…Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    const items = all
      .filter(r => String(r.status||"").trim().toLowerCase() === "pending")
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    try{ pendingCountBadge.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø©: ${items.length}`; }catch{}

    // detect new pending
    const ids = new Set(items.map(x=>x.id));
    const newOnes = items.filter(x=>!seenPending.has(x.id));
    if(seenPending.size && newOnes.length){
      // ring once per batch
      try{ stopRing?.(); }catch{}
      stopRing = ring();
      setTimeout(()=>{ try{ stopRing?.(); }catch{} }, 2200);
      notifyLocal("Ø·Ù„Ø¨ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯", `${newOnes.length} Ø·Ù„Ø¨/Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©`, location.href);
    }
    seenPending = ids;
    renderPending(items);
  }, (err)=>{
    console.error(err);
    toast("Ø®Ø·Ø£ ØµÙ„Ø§Ø­ÙŠØ§Øª", "Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø§ ØªØ³ØªØ·ÙŠØ¹ Ù‚Ø±Ø§Ø¡Ø© requests. ØªØ£ÙƒØ¯ Ø£Ù† Rules ÙÙŠÙ‡Ø§ requests/.read Ù„Ù„Ø£Ø¯Ù…Ù† Ø«Ù… Ø§Ø¹Ù…Ù„ Hard Reload.");
  });


  // ---------- Offline inbox ----------
  let seenOffline = new Set();

  function threadLabel(r){
    const name = r.displayName || r.email || r.phone || r.createdByUid;
    const t = r.lastOfflineAt || 0;
    const from = r.lastOfflineFrom || "";
    const txt = r.lastOfflineText || "";
    return { name, t, from, txt };
  }

  function renderThreads(items){
    offlineThreads.innerHTML = "";
    if(!items.length){
      offlineThreads.innerHTML = `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†.</div>`;
      return;
    }

    for(const r of items){
      const { name, t, from, txt } = threadLabel(r);
      const el = document.createElement("div");
      el.className = "item";
      el.style.cursor = "pointer";
      el.innerHTML = `
        <div>
          <div><b>${escapeHtml(name)}</b></div>
          <div class="small">${escapeHtml(from)} â€¢ ${escapeHtml(txt)}</div>
          <div class="small">${fmtTime(t)} â€¢ ${escapeHtml(r.id)}</div>
        </div>
        <div class="row">
          <button class="btn" data-open="${r.id}">ÙØªØ­</button>
        </div>
      `;
      offlineThreads.appendChild(el);
    }

    offlineThreads.querySelectorAll("button[data-open]").forEach((b)=>{
      b.addEventListener("click", ()=> openThread(b.dataset.open));
    });
  }

  async function openThread(reqId){
    selectedReqId = reqId;
    msgsBox.innerHTML = `<div class="small">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
    try{ unsubThreadMsgs?.(); }catch{}
    unsubThreadMsgs = listenOfflineMessagesForRequest(reqId, (msgs)=>{
      msgsBox.innerHTML = "";
      if(!msgs.length){
        msgsBox.innerHTML = `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</div>`;
        return;
      }
      for(const m of msgs){
        const el = document.createElement("div");
        el.className = "msg";
        const who = m.fromName || m.fromUid || "â€”";
        el.innerHTML = `<div class="who">${escapeHtml(who)} â€¢ ${fmtTime(m.createdAt||0)} <button class="btn danger mini" data-del="${m.id}">Ø­Ø°Ù</button></div><div>${escapeHtml(m.text||"")}</div>`;
        msgsBox.appendChild(el);
      }
      // wire delete buttons
      msgsBox.querySelectorAll("button[data-del]").forEach((btn)=>{
        btn.addEventListener("click", async ()=>{
          const mid = btn.getAttribute("data-del");
          btn.disabled = true;
          try{
            await deleteOfflineMessageAsAdmin(reqId, mid);
            toast("ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
          }catch(e){
            console.error(e);
            toast("Ø®Ø·Ø£", e?.message || "ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
          }finally{
            btn.disabled = false;
          }
        });
      });
msgsBox.scrollTop = msgsBox.scrollHeight;
    });
  }

  btnSendReply.addEventListener("click", async ()=>{
    if(!selectedReqId){
      toast("Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹", "Ø§Ø¶ØºØ· (ÙØªØ­) Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯");
      return;
    }
    const t = (replyText.value||"").trim();
    if(!t) return;

    btnSendReply.disabled = true;
    try{
      await sendAdminReply({ reqId: selectedReqId, adminUid: user.uid, text: t });
      replyText.value = "";
      pop();
      toast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ø¶ÙŠÙ");
    }catch(e){
      console.error(e);
      errorBeep();
      toast("Ø®Ø·Ø£", e?.message || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯");
    }finally{
      btnSendReply.disabled = false;
    }
  });

  btnClearThread.addEventListener("click", async ()=>{
    if(!selectedReqId){
      toast("Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹", "Ø§Ø¶ØºØ· (ÙØªØ­) Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯");
      return;
    }
    btnClearThread.disabled = true;
    try{
      await clearOfflineMessagesAsAdmin(selectedReqId);
      beep();
      toast("ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº", "ØªÙ… Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©");
      msgsBox.innerHTML = `<div class="small">ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº.</div>`;
    }catch(e){
      console.error(e);
      errorBeep();
      toast("Ø®Ø·Ø£", e?.message || "ØªØ¹Ø°Ø± Ø§Ù„ØªÙØ±ÙŠØº");
    }finally{
      btnClearThread.disabled = false;
    }
  });

  listenOfflineThreadsAdmin((threads)=>{
    // Merge with request info so names show even if lastOffline* wasn't updated
    const items = threads.map(th=>{
      const r = requestMap.get(th.reqId) || {};
      const lastAt = (th.last?.createdAt || r.lastOfflineAt || 0);
      return {
        id: th.reqId,
        ...r,
        lastOfflineAt: lastAt,
        lastOfflineFrom: (th.last?.fromName || th.last?.fromUid || r.lastOfflineFrom || ""),
        lastOfflineText: String(th.last?.text || r.lastOfflineText || "").slice(0, 120)
      };
    }).filter(x=> (x.lastOfflineAt||0) > 0);

    const ids = new Set(items.map(x=>x.id));
    const newOnes = items.filter(x=>!seenOffline.has(x.id));
    if(seenOffline.size && newOnes.length){
      beep();
      notifyLocal("Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø¬Ø¯ÙŠØ¯Ø©", `${newOnes.length} Ù…Ø­Ø§Ø¯Ø«Ø©/Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©`, location.href);
    }
    seenOffline = ids;
    renderThreads(items);
  });


</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¹ØµØ§Ù… (Secure)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #333; color: white; padding: 20px; margin: 0; }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ…Ø§Ù…Ø§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ */
        #dashboard-content { display: none; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ØªØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹) */
        #security-check {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #e74c3c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù„ÙˆØ­Ø© */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; padding-bottom: 20px; }
        .request-item { background: #444; padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .btn-accept { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
    </style>
</head>
<body>

    <div id="security-check">
        <div class="loader"></div>
        <p style="margin-top: 15px; color: #bbb;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</p>
    </div>

    <div id="dashboard-content">
        <div class="header">
            <h2>ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… ğŸ•¹ï¸</h2>
            <div>
                <span style="color: #4cd137; margin-left: 10px;">â— Ù…ØªØµÙ„ ÙƒÙ…Ø¯ÙŠØ±</span>
                <button onclick="logout()" style="background: #555; color: white; border: none; padding: 5px 10px; cursor: pointer;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <h3 style="margin-top: 30px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:</h3>
        <div id="requests-list">
            <p style="color: #777;" id="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©...</p>
        </div>
    </div>
<h3 style="margin-top: 30px; border-top: 1px solid #555; padding-top: 20px;">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Offline) ğŸ“©:</h3>
<div id="messages-list">
    <p style="color: #777;" id="no-msgs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©...</p>
</div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onChildAdded, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âš ï¸âš ï¸âš ï¸ Ø¶Ø¹ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ù‡Ù†Ø§ Ø¨Ø¯Ù‚Ø© âš ï¸âš ï¸âš ï¸
        const ADMIN_EMAIL = "esshoo@gmail.com"; 

        const firebaseConfig = {
            apiKey: "AIzaSyCV6xsRfSlpt5t9YNCVIivxJoRwj1TIexs",
            authDomain: "essam-support.firebaseapp.com",
            projectId: "essam-support",
            storageBucket: "essam-support.firebasestorage.app",
            messagingSenderId: "1062222968750",
            appId: "1:1062222968750:web:1c827c20729f76fbe7ba3f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Ø­Ø§Ø±Ø³ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© (Security Guard) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù‡Ùˆ Ø¥ÙŠÙ…ÙŠÙ„ Ø¹ØµØ§Ù…ØŸ
                if (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    // âœ… Ù†Ø¹Ù…ØŒ Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± -> Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„
                    document.getElementById('security-check').style.display = 'none';
                    document.getElementById('dashboard-content').style.display = 'block';
                    startDashboardLogic(); // Ø´ØºÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                } else {
                    // âŒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ù„ÙƒÙ† Ù„ÙŠØ³ Ø§Ù„Ù…Ø¯ÙŠØ± -> Ø­ÙˆÙ„Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
                    alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·!");
                    window.location.href = "client.html";
                }
            } else {
                // âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ØµÙ„Ø§Ù‹ -> Ø§Ø±Ø¬Ø¹ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©
                window.location.href = "index.html";
            }
        });

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„ÙˆØ­Ø© (ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ù…Ø§Ø­) ---
        function startDashboardLogic() {
            const requestsRef = ref(db, 'requests');
            onChildAdded(requestsRef, (snapshot) => {
                const data = snapshot.val();
                const key = snapshot.key;
                if (data.status === 'pending') {
                    document.getElementById('empty-msg').style.display = 'none';
                    addRequestToUI(key, data.name, data.phone);
                }
            });
        }

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†
const messagesRef = ref(db, 'messages');
onChildAdded(messagesRef, (snapshot) => {
    const msg = snapshot.val();
    document.getElementById('no-msgs').style.display = 'none';
    
    const div = document.createElement('div');
    div.className = 'request-item';
    div.style.background = '#2c3e50'; // Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
    div.innerHTML = `
        <div>
            <strong>ğŸ‘¤ ${msg.name}</strong> <small>(${msg.type})</small><br>
            <span style="color:#aaa">ğŸ“ ØªÙˆØ§ØµÙ„: ${msg.contact}</span><br>
            <p style="background:rgba(0,0,0,0.2); padding:5px; border-radius:5px; margin-top:5px;">${msg.content}</p>
        </div>
        <div>
            <small style="color:#888">${new Date(msg.timestamp).toLocaleTimeString()}</small>
        </div>
    `;
    document.getElementById('messages-list').appendChild(div);
});
        
        function addRequestToUI(key, name, phone) {
            const list = document.getElementById('requests-list');
            const div = document.createElement('div');
            div.className = 'request-item';
            div.id = `req-${key}`;
            div.innerHTML = `
                <div>
                    <strong>ğŸ‘¤ ${name}</strong> <br>
                    <small>ğŸ“ ${phone}</small>
                </div>
                <div>
                    <button class="btn btn-accept" onclick="acceptUser('${key}', '${name}')">Ù‚Ø¨ÙˆÙ„ âœ…</button>
                    <button class="btn btn-reject" onclick="rejectUser('${key}')">Ø±ÙØ¶ âŒ</button>
                </div>
            `;
            list.appendChild(div);
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… (Global)
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… (Global)
        window.acceptUser = function(key, name) {
            // 1. Ù†ØºÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ù„Ù†Ø¹Ø±Ù Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¯Ø£Øª
            const btn = document.querySelector(`#req-${key} .btn-accept`);
            if(btn) btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...";

            // 2. Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ (ÙˆÙ†Ù†ØªØ¸Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©)
            update(ref(db, `requests/${key}`), { status: 'accepted' })
            .then(() => {
                // âœ… Ù†Ø¬Ø§Ø­: Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                console.log("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±");
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                document.getElementById(`req-${key}`).style.display = 'none';

                // 3. ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠØ¯ÙŠÙˆØŒ ÙˆÙ„Ø§Ø­Ù‚Ø§Ù‹ Ù†ØºÙŠØ±Ù‡Ø§ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©)
                // Ù†Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© (key) ÙˆØ§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ±
                window.open(`video.html?room=${key}&role=admin&name=${encodeURIComponent(name)}`, '_blank');
            })
            .catch((error) => {
                // âŒ ÙØ´Ù„: Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±ÙØ¶ (ÙˆÙ‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ù Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©)
                console.error("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", error);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± ÙƒÙ…Ø§ ÙƒØ§Ù†
                if(btn) btn.innerText = "Ù‚Ø¨ÙˆÙ„ âœ…";

                // Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ùƒ Ø¨Ø§Ù„Ø®Ø·Ø£
                alert("â›” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨!\nÙ‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Rules).\n\nØ±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø¬ÙˆØ¬Ù„:\n" + error.message);
            });
        }

        window.rejectUser = function(key) {
            // Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ù„Ø±ÙØ¶ (Ù†Ù†ØªØ¸Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯)
            update(ref(db, `requests/${key}`), { status: 'rejected' })
            .then(() => {
                document.getElementById(`req-${key}`).style.display = 'none';
            })
            .catch((error) => {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¶: " + error.message);
            });
        }

        window.logout = function() {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Error signing out: ", error);
            });
        }
    </script>
</body>
</html>





<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <title>Essam Support • Admin</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">لوحة المدير</h1>
        <div class="small" id="who"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnEnableNotifs">تفعيل الإشعارات</button>
      <button class="btn danger" id="btnLogout">تسجيل خروج</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="title">الطلبات الجديدة (Pending)</div>
      <div class="small">اضغط قبول لإنشاء غرفة وإرسال رابط للمستخدم.</div>
      <hr/>
      <div class="list" id="reqList"></div>
    </div>

    <div class="card">
      <div class="title">رسائل أوفلاين</div>
      <div class="small">اختر طلباً لمشاهدة رسائله (تظهر تلقائياً).</div>
      <hr/>
      <div class="row">
        <input class="input" id="reqIdForMsgs" placeholder="اكتب Request ID لعرض الرسائل" />
        <button class="btn" id="btnLoadMsgs">عرض</button>
      </div>
      <div class="chatlog" id="msgsBox" style="height:360px; margin-top:12px"></div>
    </div>
  </div>

  <div class="footer">نصيحة: فعّل الإشعارات لتصلك تنبيهات عند وصول طلبات/رسائل جديدة.</div>
</div>

<script type="module">
  import { requireAuth, logout } from "./assets/auth.js";
  import { isAdmin, listenPendingRequests, acceptRequest, rejectRequest, listenOfflineMessagesForRequest } from "./assets/db.js";
  import { toast } from "./assets/ui.js";
  import { initMessaging, wireNotificationButton } from "./assets/notifications.js";

  const who = document.getElementById("who");
  const reqList = document.getElementById("reqList");
  const btnLogout = document.getElementById("btnLogout");
  const reqIdForMsgs = document.getElementById("reqIdForMsgs");
  const btnLoadMsgs = document.getElementById("btnLoadMsgs");
  const msgsBox = document.getElementById("msgsBox");

  let unsubMsgs = null;

  // ✅ لا Redirect سريع: requireAuth الآن ينتظر auth init
  const user = await requireAuth("index.html");

  // ✅ مهم: ابعت الإيميل
  const admin = await isAdmin(user.uid, user.email || "");
  if(!admin){
    toast("غير مصرح", "هذا الحساب ليس مديراً.");
    location.replace("index.html");
  }

  who.textContent = `مرحباً ${user.displayName || user.email || user.uid}`;

  await initMessaging();
  wireNotificationButton("#btnEnableNotifs");

  btnLogout.addEventListener("click", async ()=>{
    await logout();
    location.replace("index.html");
  });

  function render(items){
    reqList.innerHTML = "";
    if(!items.length){
      reqList.innerHTML = '<div class="small">لا توجد طلبات معلّقة الآن.</div>';
      return;
    }
    for(const r of items){
      const el = document.createElement("div");
      el.className="item";
      el.innerHTML = `
        <div class="meta">
          <div class="title">طلب #${r.id}</div>
          <div class="sub">${r.createdByType} • ${r.displayName || r.email || "—"} • ${r.phone || "—"}</div>
          <div class="sub">${(r.note||"").slice(0,120)}</div>
        </div>
        <div class="row">
          <button class="btn ok" data-act="accept">قبول</button>
          <button class="btn danger" data-act="reject">رفض</button>
        </div>
      `;

      el.querySelector('[data-act="accept"]').addEventListener("click", async ()=>{
        try{
          await acceptRequest({ reqId: r.id, adminUid: user.uid });
          toast("تم القبول", "تم إنشاء غرفة للمستخدم.");
        }catch(e){
          console.error(e);
          toast("فشل القبول", e?.message || "");
        }
      });

      el.querySelector('[data-act="reject"]').addEventListener("click", async ()=>{
        try{
          await rejectRequest({ reqId: r.id, adminUid: user.uid });
          toast("تم الرفض", "تم تحديث حالة الطلب.");
        }catch(e){
          console.error(e);
          toast("فشل الرفض", e?.message || "");
        }
      });

      reqList.appendChild(el);
    }
  }

  listenPendingRequests(render);

  btnLoadMsgs.addEventListener("click", ()=>{
    const id = (reqIdForMsgs.value||"").trim();
    if(!id) return;

    msgsBox.innerHTML = "";
    if(unsubMsgs) try{ unsubMsgs(); }catch{}

    unsubMsgs = listenOfflineMessagesForRequest(id, (msgs)=>{
      msgsBox.innerHTML = msgs.map(m=> `
        <div class="msg">
          <div class="who">${m.fromName || m.fromUid || "unknown"} • ${new Date(m.createdAt||Date.now()).toLocaleString()}</div>
          <div>${String(m.text||"").replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
        </div>
      `).join("") || '<div class="small">لا توجد رسائل.</div>';

      msgsBox.scrollTop = msgsBox.scrollHeight;
    });
  });
</script>
</body>
</html>

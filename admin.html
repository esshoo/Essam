<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <title>Essam Support • Admin</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">لوحة المدير</h1>
        <div class="small" id="who"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnEnableNotifs">تفعيل الإشعارات</button>
      <button class="btn danger" id="btnLogout">تسجيل خروج</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="title">الطلبات الجديدة (Pending)</div>
      <div class="small">تظهر تلقائيًا. اضغط قبول لإنشاء غرفة.</div>
      <hr/>
      <div class="list" id="reqList"></div>
    </div>

    <div class="card">
      <div class="title">رسائل العملاء (الأوفلاين)</div>
      <div class="small">تظهر تلقائيًا عند تحديث أي طلب برسالة جديدة.</div>
      <hr/>
      <div class="row" style="align-items:flex-start; gap:12px">
        <div style="flex:1; min-width:260px">
          <div class="small">صندوق الوارد</div>
          <div class="list" id="offlineThreads"></div>
        </div>
        <div style="flex:1; min-width:260px">
          <div class="small">المحادثة</div>
          <div class="chatlog" id="msgsBox" style="height:240px; margin-top:8px"></div>
          <div class="row" style="margin-top:10px">
            <input class="input" id="replyText" placeholder="اكتب ردًا للعميل..." />
            <button class="btn" id="btnSendReply">رد</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn danger" id="btnClearThread">تفريغ المحادثة</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">نظام الدعم المطور • جميع الطلبات مرتبطة بمعرف المستخدم الثابت لضمان عدم التكرار.</div>
</div>

<script type="module">
  import { requireAuth, logout } from "./assets/auth.js";
  // ✅ تم تحديث الموديولات لتطابق المسميات الجديدة في db.js
  import {
    isAdmin,
    listenPendingRequests,
    acceptRequest,
    rejectRequest,
    listenOfflineMessages, // بديلة لـ listenOfflineMessagesForRequest
    listenRequestsWithOffline,
    clearOfflineMessagesAsAdmin,
    sendAdminReply
  } from "./assets/db.js";
  import { toast, fmtTime, escapeHtml } from "./assets/ui.js";
  import { initMessaging, wireNotificationButton, notifyLocal } from "./assets/notifications.js";
  import { primeAudio, ring, beep, pop, errorBeep } from "./assets/sounds.js";

  const who = document.getElementById("who");
  const reqList = document.getElementById("reqList");
  const btnLogout = document.getElementById("btnLogout");
  const offlineThreads = document.getElementById("offlineThreads");
  const msgsBox = document.getElementById("msgsBox");
  const replyText = document.getElementById("replyText");
  const btnSendReply = document.getElementById("btnSendReply");
  const btnClearThread = document.getElementById("btnClearThread");

  let selectedReqId = "";
  let unsubThreadMsgs = null;

  window.addEventListener("pointerdown", () => primeAudio(), { once:true });

  const user = await requireAuth("index.html");
  const adminOk = await isAdmin(user.uid, user.email || "");
  if (!adminOk) {
    location.replace("index.html");
    throw new Error("Not admin");
  }

  who.textContent = `Admin: ${user.email || user.uid}`;
  btnLogout.addEventListener("click", async () => {
    await logout();
    location.replace("index.html");
  });

  try { await initMessaging(); } catch {}
  wireNotificationButton("#btnEnableNotifs");

  // ---------- الطلبات الجديدة ----------
  let seenPending = new Set();
  let stopRing = null;

  function renderPending(items){
    reqList.innerHTML = "";
    if(!items.length){
      reqList.innerHTML = `<div class="small">لا توجد طلبات معلقة.</div>`;
      return;
    }

    for(const r of items){
      const name = r.displayName || r.email || r.createdByUid;
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div><b>${escapeHtml(name)}</b></div>
          <div class="small">${escapeHtml(r.note || "")}</div>
          <div class="small">${fmtTime(r.createdAt)}</div>
        </div>
        <div class="row">
          <button class="btn" data-act="accept" data-id="${r.reqId}">قبول</button>
          <button class="btn danger" data-act="reject" data-id="${r.reqId}">رفض</button>
        </div>
      `;
      reqList.appendChild(el);
    }

    reqList.querySelectorAll("button[data-act]").forEach(b => {
      b.addEventListener("click", async () => {
        const id = b.dataset.id;
        if(b.dataset.act === "accept"){
          const { roomId, roomToken } = await acceptRequest(id);
          location.href = `video.html?room=${roomId}&token=${roomToken}`;
        } else {
          await rejectRequest(id);
        }
      });
    });
  }

  listenPendingRequests(items => {
    const ids = new Set(items.map(x => x.reqId));
    const newOnes = items.filter(x => !seenPending.has(x.reqId));
    if(seenPending.size && newOnes.length){
      try{ stopRing?.(); }catch{}
      stopRing = ring();
      setTimeout(() => stopRing?.(), 3000);
      notifyLocal("طلب دعم جديد", `لديك ${newOnes.length} طلبات جديدة`, location.href);
    }
    seenPending = ids;
    renderPending(items);
  });

  // ---------- الرسائل أوفلاين ----------
  function renderThreads(items){
    offlineThreads.innerHTML = "";
    if(!items.length){
      offlineThreads.innerHTML = `<div class="small">لا توجد رسائل.</div>`;
      return;
    }

    items.forEach(r => {
      const el = document.createElement("div");
      el.className = "item";
      el.style.cursor = "pointer";
      el.innerHTML = `
        <div style="flex:1">
          <b>${escapeHtml(r.displayName || "Client")}</b>
          <div class="small">${escapeHtml(r.lastOfflineText || "")}</div>
        </div>
        <button class="btn" data-open="${r.reqId}">فتح</button>
      `;
      offlineThreads.appendChild(el);
    });

    offlineThreads.querySelectorAll("button[data-open]").forEach(b => {
      b.addEventListener("click", () => openThread(b.dataset.open));
    });
  }

  async function openThread(reqId){
    selectedReqId = reqId;
    msgsBox.innerHTML = `<div class="small">جاري التحميل...</div>`;
    if(unsubThreadMsgs) unsubThreadMsgs();
    unsubThreadMsgs = listenOfflineMessages(reqId, msgs => {
      msgsBox.innerHTML = "";
      msgs.forEach(m => {
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<div class="who">${escapeHtml(m.fromName)}</div><div>${escapeHtml(m.text)}</div>`;
        msgsBox.appendChild(div);
      });
      msgsBox.scrollTop = msgsBox.scrollHeight;
    });
  }

  btnSendReply.addEventListener("click", async () => {
    if(!selectedReqId || !replyText.value.trim()) return;
    await sendAdminReply({ reqId: selectedReqId, adminUid: user.uid, text: replyText.value });
    replyText.value = "";
    pop();
    toast("تم إرسال الرد");
  });

  btnClearThread.addEventListener("click", async () => {
    if(!selectedReqId) return;
    await clearOfflineMessagesAsAdmin(selectedReqId);
    msgsBox.innerHTML = "";
    toast("تم تفريغ المحادثة");
  });

  listenRequestsWithOffline(items => renderThreads(items));

</script>
</body>
</html>
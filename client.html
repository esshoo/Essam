<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .user-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; border: 3px solid #0088cc; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 16px; }
        .hidden { display: none; }
        .pulse { animation: pulse 1.5s infinite; font-size: 40px; margin: 10px 0; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

    <div class="card" id="form-card">
        <img id="u-img" src="" class="user-img">
        <h3 id="u-name">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h3>
        <p style="color: #666;">Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„Ø·Ù„Ø¨ Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹ØµØ§Ù…</p>
        
        <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ (Ù„Ù„ØªÙˆØ§ØµÙ„)" style="width:90%; padding:10px; margin-top:10px; border:1px solid #ddd; border-radius:5px;">
        
        <button onclick="submitRequest()">ğŸ“ Ø·Ù„Ø¨ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†</button>
        <button onclick="logout()" style="background:#555; margin-top:10px;">Ø®Ø±ÙˆØ¬</button>
    </div>

<div class="card hidden" id="waiting-card">
    <div class="pulse">â³</div>
    <h3 id="wait-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
    <p id="wait-msg">Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.</p>

    <div id="client-actions">
        <button onclick="showClientMsg()" style="background: #f39c12; margin-top: 15px;">ğŸ“© ØªØ±Ùƒ Ø±Ø³Ø§Ù„Ø© (Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)</button>
    </div>

    <div id="client-msg-form" class="hidden" style="margin-top: 15px;">
        <textarea id="c-msg-content" placeholder="Ø¨Ù…Ø§Ø°Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ" style="width: 90%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" rows="3"></textarea>
        <button onclick="sendClientMessage()" style="background: #27ae60;">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCV6xsRfSlpt5t9YNCVIivxJoRwj1TIexs", // ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙØ§ØªÙŠØ­Ùƒ
            authDomain: "essam-support.firebaseapp.com",
            projectId: "essam-support",
            storageBucket: "essam-support.firebasestorage.app",
            messagingSenderId: "1062222968750",
            appId: "1:1062222968750:web:1c827c20729f76fbe7ba3f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let userUid = null;
        let userName = "";

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUid = user.uid;
                userName = user.displayName || "Ø¹Ù…ÙŠÙ„ Ù…Ù…ÙŠØ²";
                
                document.getElementById('u-name').innerText = "Ø£Ù‡Ù„Ø§Ù‹ØŒ " + userName;
                document.getElementById('u-img').src = user.photoURL || "https://ui-avatars.com/api/?name=" + userName;
            } else {
                window.location.href = "index.html";
            }
        });

        window.submitRequest = function() {
            const phone = document.getElementById('phone').value;
            if(!phone) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");

            document.getElementById('form-card').classList.add('hidden');
            document.getElementById('waiting-card').classList.remove('hidden');

            const newRequestRef = push(ref(db, 'requests'));
            const reqId = newRequestRef.key;
            
            set(newRequestRef, {
                name: userName + " (Google)",
                phone: phone,
                status: 'pending',
                timestamp: Date.now(),
                uid: userUid
            });

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¯
            onValue(ref(db, `requests/${reqId}/status`), (snapshot) => {
                const status = snapshot.val();
                if (status === 'accepted') {
                    // ØªØ­ÙˆÙŠÙ„ Ù„ØºØ±ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    window.location.href = `video.html?room=${reqId}&role=client`;
                } else if (status === 'rejected') {
                    alert("Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹.");
                    location.reload();
                }
            });
        }

        window.logout = function() {
            signOut(auth).then(() => window.location.href = "index.html");
        }
		window.showClientMsg = function() {
    document.getElementById('client-actions').classList.add('hidden');
    document.getElementById('client-msg-form').classList.remove('hidden');
}

window.sendClientMessage = function() {
    const content = document.getElementById('c-msg-content').value;
    if(!content) return alert("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ");

    // Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙˆØ¬Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
    push(ref(db, 'messages'), {
        name: auth.currentUser.displayName,
        contact: auth.currentUser.email, // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        content: content,
        type: 'Google User',
        timestamp: Date.now()
    }).then(() => {
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! Ø³ÙŠØµÙ„Ùƒ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ: " + auth.currentUser.email);
        location.reload();
    });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø²Ø¡ Ø§Ù„Ø±ÙØ¶ (Ø¯Ø§Ø®Ù„ onValue):
/*
else if (status === 'rejected') {
    document.getElementById('wait-title').innerText = "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹";
    document.getElementById('wait-msg').innerText = "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ø±Ø³Ø§Ù„Ø© ÙˆØ³Ù†Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.";
    document.getElementById('wait-msg').style.color = "#e74c3c";
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙˆØ±Ø§Ù‹
    showClientMsg();
}
*/
    </script>
</body>
</html>


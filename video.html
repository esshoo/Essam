<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</title>
    <style>
        body { margin: 0; background: #222; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; color: white; }
        video { width: 45%; max-width: 600px; border-radius: 10px; background: black; margin: 10px; border: 2px solid #444; }
        .controls { position: fixed; bottom: 20px; display: flex; gap: 20px; }
        button { padding: 15px 30px; border-radius: 50px; border: none; cursor: pointer; font-size: 18px; font-weight: bold; }
        .btn-end { background: #e74c3c; color: white; }
        .btn-mic { background: #3498db; color: white; }
        #status { position: absolute; top: 20px; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; }
    </style>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

    <div id="status">Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„... â³</div>

    <div style="display: flex; width: 100%; justify-content: center; flex-wrap: wrap;">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="controls">
        <button class="btn-mic" onclick="toggleMic()">ğŸ¤ ÙƒØªÙ… Ø§Ù„ØµÙˆØª</button>
        <button class="btn-end" onclick="endCall()">âŒ Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>

    <script>
        // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø­Ø±ÙŠ)
        const urlParams = new URLSearchParams(window.location.search);
        const ROOM_ID = urlParams.get('room'); // Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨
        const ROLE = urlParams.get('role');    // admin Ø£Ùˆ client

        if (!ROOM_ID || !ROLE) {
            alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­! ÙŠØ¬Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.");
            window.location.href = 'index.html';
        }

        const statusEl = document.getElementById('status');
        let localStream;
        let currentCall;

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ± (Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ 123
        // Ø§Ù„Ù…Ø¯ÙŠØ± Ø³ÙŠÙƒÙˆÙ† Ø§Ø³Ù…Ù‡: admin-123
        // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³ÙŠÙƒÙˆÙ† Ø§Ø³Ù…Ù‡: client-123
        const myPeerId = `${ROLE}-${ROOM_ID}`;
        const targetPeerId = ROLE === 'admin' ? `client-${ROOM_ID}` : `admin-${ROOM_ID}`;

        // Ø¥Ø¹Ø¯Ø§Ø¯ PeerJS
        const peer = new Peer(myPeerId);

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            localStream = stream;
            document.getElementById('localVideo').srcObject = stream;

            if (ROLE === 'admin') {
                statusEl.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„... ğŸ“";
                // Ø§Ù„Ù…Ø¯ÙŠØ± Ù‡Ùˆ Ù…Ù† ÙŠØ¨Ø§Ø¯Ø± Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ø£Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù‚Ø¨Ù„Ù‡ ØºØ§Ù„Ø¨Ø§Ù‹)
                connectToClient();
            } else {
                statusEl.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹ØµØ§Ù…... â³";
            }
        }).catch(err => {
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
        });

        // 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ„Ù„Ù…Ø¯ÙŠØ± Ø£ÙŠØ¶Ø§Ù‹)
        peer.on('call', call => {
            statusEl.innerText = "ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„! âœ…";
            call.answer(localStream); // Ø§Ù„Ø±Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ
            
            call.on('stream', remoteStream => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
            currentCall = call;
        });

        // 2. Ø¯Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„
        function connectToClient() {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø­ØªÙ‰ ÙŠÙ†Ø¬Ø­ (ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø³Ù‡ Ø¨ÙŠØ­Ù…Ù„ Ø§Ù„ØµÙØ­Ø©)
            const connLoop = setInterval(() => {
                if (currentCall) { clearInterval(connLoop); return; } // Ù„Ùˆ Ø§ØªØµÙ„Ù†Ø§ Ø®Ù„Ø§Øµ ÙˆÙ‚Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                
                const call = peer.call(targetPeerId, localStream);
                
                if (call) {
                    call.on('stream', remoteStream => {
                        document.getElementById('remoteVideo').srcObject = remoteStream;
                        statusEl.innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ âœ…";
                        clearInterval(connLoop);
                        currentCall = call;
                    });
                    
                    // Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø³Ù‡ Ù…ÙÙ†Ø´ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ù„Ø®Ø·Ø£ Ø¯Ù‡ Ù‡ÙŠØ­ØµÙ„ ÙˆÙ‡Ù†Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ
                    call.on('error', err => { console.log("Retrying connection..."); });
                }
            }, 2000); 
        }

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        function toggleMic() {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
        }

        function endCall() {
            if (currentCall) currentCall.close();
            window.close(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        }
    </script>
</body>
</html>

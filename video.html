<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0088cc; --bg: #e5ddd5; --white: #ffffff; --green: #25d366; --red: #ff3b30; --msg-me: #dcf8c6; --dark: #333; }
        body { font-family: 'Tajawal', sans-serif; margin: 0; background: #f0f2f5; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        .screen { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header { background: var(--primary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 60px; box-sizing: border-box; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: bold; font-size: 1.1em; }
        .user-status { font-size: 0.75em; opacity: 0.9; }
        .controls-area { display: flex; align-items: center; gap: 8px; }
        .call-btn { background: none; border: none; color: white; font-size: 1.3em; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .call-btn:hover { background: rgba(255,255,255,0.2); }
        #my-cam-btn { font-size: 1.1em; border: 1px solid white; background: rgba(255,0,0,0.5); display: none; }
        .cam-on { background: var(--green) !important; border-color: var(--green) !important; }
        .logout-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 0.8em; }
        .btn-active-call { background-color: var(--red) !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); } }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: soft-light; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg-me { background: var(--msg-me); align-self: flex-end; border-bottom-left-radius: 0; }
        .msg-other { background: var(--white); align-self: flex-start; border-bottom-right-radius: 0; }
        .sys-msg { align-self: center; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; font-size: 0.8em; color: white; margin: 5px 0; text-align: center; }
        .media-thumb { max-width: 200px; max-height: 150px; border-radius: 10px; margin-top: 5px; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); }
        .file-link { display: flex; align-items: center; text-decoration: none; color: #333; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 10px; margin-top: 5px; }
        .chat-footer { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .chat-footer input { margin: 0; flex: 1; border: none; padding: 12px; border-radius: 20px; outline: none; }
        .attach-btn { font-size: 1.5em; cursor: pointer; color: #555; padding: 0 10px; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        #incoming-modal, #video-modal, #lightbox-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; }
        #incoming-modal { background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; color: white; }
        #video-modal { background: black; }
        #lightbox-modal { background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 200; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 140px; background: #333; border: 2px solid white; border-radius: 10px; object-fit: cover; transform: scaleX(-1); }
        #lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #lightbox-video { max-width: 100%; max-height: 100%; }
        .close-lightbox { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 201; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .incoming-actions { margin-top: 50px; display: flex; gap: 40px; }
        .action-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; color: white; border: none; }
    </style>
</head>
<body>

    <div id="chat-screen" class="screen">
        <div class="header">
            <div class="user-info">
                <div class="user-name" id="chat-header-name">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
                <div class="user-status" id="connection-status">Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</div>
            </div>
            <div class="controls-area">
                <button class="call-btn" id="btn-audio" onclick="toggleCall('audio')">üìû</button>
                <button class="call-btn" id="btn-video" onclick="toggleCall('video')">üìπ</button>
                <button class="call-btn" id="my-cam-btn" onclick="toggleMyCam()" title="ÿ™ŸÅÿπŸäŸÑ/ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß">üö´</button>
                <button class="logout-btn" onclick="exitChat()">ÿ•ŸÜŸáÿßÿ°</button>
            </div>
        </div>

        <div class="chat-body" id="chat-box"></div>

        <div class="chat-footer">
            <span class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</span>
            <input type="file" id="file-input" hidden onchange="sendFile(this)">
            <input type="text" id="msg-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." onkeypress="if(event.key==='Enter') sendText()">
            <button class="send-btn" onclick="sendText()">‚û§</button>
        </div>
    </div>

    <div id="incoming-modal">
        <div style="font-size:50px; margin-bottom:20px">üì≤</div>
        <h3 id="incoming-caller-name">ÿßÿ™ÿµÿßŸÑ Ÿàÿßÿ±ÿØ...</h3>
        <p>Ÿäÿ±ÿ∫ÿ® ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØÿ´ ŸÖÿπŸÉ</p>
        <div class="incoming-actions">
            <button class="action-btn" style="background: var(--red);" onclick="rejectCall()">‚úñ</button>
            <button class="action-btn" style="background: var(--green);" onclick="acceptCall()">‚úî</button>
        </div>
    </div>

    <div id="video-modal">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <button class="action-btn" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:var(--red);" onclick="endCurrentCall()">üìû</button>
    </div>

    <div id="lightbox-modal">
        <div class="close-lightbox" onclick="closeLightbox()">‚úñ</div>
        <div id="lightbox-content"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const ROOM_ID = urlParams.get('room');
        const ROLE = urlParams.get('role');
        let MY_NAME = urlParams.get('name') || "ŸÖÿ≥ÿ™ÿÆÿØŸÖ";

        if (!ROOM_ID || !ROLE) {
            alert("ÿ±ÿßÿ®ÿ∑ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠!");
            window.location.href = 'index.html';
        }

        // --- ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™ (ID Sanitization) ---
        const cleanRoomId = ROOM_ID.replace(/[^a-zA-Z0-9]/g, '');
        const myPeerId = `${ROLE}_${cleanRoomId}`;
        const targetPeerId = ROLE === 'admin' ? `client_${cleanRoomId}` : `admin_${cleanRoomId}`;
        const displayName = ROLE === 'admin' ? "ÿßŸÑŸÖŸáŸÜÿØÿ≥ ÿπÿµÿßŸÖ" : MY_NAME;

        let peer, conn, callObject = null, localStream = null, isCallActive = false, incomingReq = null;
        let audioCtx = null, ringOsc = null, myCamEnabled = false;

        window.onload = function() {
            initUI();
            startPeerConnection();
            initAudio();
        };

        function initUI() {
            if (ROLE === 'admin') {
                document.getElementById('my-cam-btn').style.display = 'flex';
                document.getElementById('chat-header-name').innerText = MY_NAME;
            } else {
                document.getElementById('chat-header-name').innerText = "ÿßŸÑŸÖŸáŸÜÿØÿ≥ ÿπÿµÿßŸÖ";
                myCamEnabled = true;
            }
        }

        function startPeerConnection() {
            document.getElementById('connection-status').innerText = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...";
            peer = new Peer(myPeerId);

            peer.on('open', (id) => {
                document.getElementById('connection-status').innerText = "ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ¥ÿ®ŸÉÿ© ‚úÖ";
                if (ROLE === 'admin') setTimeout(connectToTarget, 1000);
            });

            peer.on('error', (err) => {
                if(err.type === 'peer-unavailable' && ROLE === 'admin') {
                    setTimeout(connectToTarget, 3000);
                }
            });

            peer.on('connection', (c) => handleDataConnection(c));
            peer.on('call', (call) => handleIncomingCall(call));
        }

        function connectToTarget() {
            if (!peer || peer.destroyed) return;
            const c = peer.connect(targetPeerId, { metadata: { name: displayName } });
            handleDataConnection(c);
        }

        function handleDataConnection(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('connection-status').innerText = "ŸÖÿ™ÿµŸÑ ‚úÖ";
                if (ROLE === 'client') conn.send({ type: 'name-handshake', name: displayName });
                notifyUser('msg');
            });
            conn.on('data', (data) => {
                if(typeof data === 'string') {
                    addMessage(data, 'other');
                    notifyUser('msg');
                } else if (data.type === 'name-handshake') {
                    document.getElementById('chat-header-name').innerText = data.name;
                    addSystemMessage(`ÿßŸÜÿ∂ŸÖ: ${data.name}`);
                } else if (data.type === 'file') {
                    const blob = new Blob([new Uint8Array(data.file)], { type: data.fileType });
                    renderFileMessage({ file: blob, fileType: data.fileType, fileName: data.fileName }, 'other');
                    notifyUser('msg');
                } else if (data.type === 'call-end') {
                    endCurrentCall(false);
                }
            });
        }

        function toggleMyCam() {
            myCamEnabled = !myCamEnabled;
            const btn = document.getElementById('my-cam-btn');
            btn.classList.toggle('cam-on', myCamEnabled);
            btn.innerHTML = myCamEnabled ? "üì∑" : "üö´";
            if(localStream && localStream.getVideoTracks()[0]) {
                localStream.getVideoTracks()[0].enabled = myCamEnabled;
            }
        }

        function toggleCall(type) {
            if (isCallActive) {
                if (confirm("ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖŸÉÿßŸÑŸÖÿ©ÿü")) endCurrentCall(true);
            } else startCall(type);
        }

        function startCall(type) {
            if(!conn || !conn.open) return alert("ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ∑ÿ±ŸÅ ÿßŸÑÿ¢ÿÆÿ±...");
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                if (ROLE === 'admin') localStream.getVideoTracks()[0].enabled = myCamEnabled;
                if(type === 'video') {
                    document.getElementById('video-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                }
                const call = peer.call(targetPeerId, stream, { metadata: { type: type, name: displayName } });
                handleCallStream(call);
                setCallActiveState(true, type);
            }).catch(err => alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß: " + err));
        }

        function handleIncomingCall(call) {
            incomingReq = call;
            document.getElementById('incoming-modal').style.display = 'flex';
            document.getElementById('incoming-caller-name').innerText = call.metadata?.name || "ŸÖÿ™ÿµŸÑ";
            notifyUser('ring');
        }

        function acceptCall() {
            stopNotification();
            document.getElementById('incoming-modal').style.display = 'none';
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                if (ROLE === 'admin') localStream.getVideoTracks()[0].enabled = myCamEnabled;
                incomingReq.answer(stream);
                if(incomingReq.metadata.type === 'video') {
                    document.getElementById('video-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                }
                handleCallStream(incomingReq);
                setCallActiveState(true, incomingReq.metadata.type);
            });
        }

        function rejectCall() {
            stopNotification();
            document.getElementById('incoming-modal').style.display = 'none';
            if(incomingReq) incomingReq.close();
        }

        function handleCallStream(call) {
            callObject = call;
            call.on('stream', rs => {
                if(document.getElementById('video-modal').style.display === 'block') {
                    document.getElementById('remote-video').srcObject = rs;
                } else {
                    const a = new Audio(); a.srcObject = rs; a.play();
                }
            });
            call.on('close', () => endCurrentCall(false));
        }

        function endCurrentCall(notify = true) {
            if(callObject) callObject.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-modal').style.display = 'none';
            setCallActiveState(false);
            if(notify && conn) conn.send({type: 'call-end'});
        }

        function setCallActiveState(active, type) {
            isCallActive = active;
            document.getElementById('btn-audio').classList.toggle('btn-active-call', active && type==='audio');
            document.getElementById('btn-video').classList.toggle('btn-active-call', active && type==='video');
        }

        function sendText() {
            const el = document.getElementById('msg-input');
            if(!el.value || !conn) return;
            conn.send(el.value);
            addMessage(el.value, 'me');
            el.value = '';
        }

        function addMessage(c, s) {
            const b = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = `message ${s === 'me' ? 'msg-me' : 'msg-other'}`;
            d.innerText = c;
            b.appendChild(d);
            b.scrollTop = b.scrollHeight;
        }

        function addSystemMessage(t) {
            const b = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = 'sys-msg'; d.innerText = t;
            b.appendChild(d); b.scrollTop = b.scrollHeight;
        }

        function sendFile(input) {
            const f = input.files[0]; if (!f || !conn) return;
            const r = new FileReader();
            r.onload = (e) => {
                conn.send({ type: 'file', file: e.target.result, fileName: f.name, fileType: f.type });
                renderFileMessage({ file: new Blob([e.target.result], {type: f.type}), fileType: f.type, fileName: f.name }, 'me');
            };
            r.readAsArrayBuffer(f);
        }

        function renderFileMessage(d, s) {
            const b = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `message ${s === 'me' ? 'msg-me' : 'msg-other'}`;
            const url = URL.createObjectURL(d.file);
            if (d.fileType.startsWith('image/')) div.innerHTML = `<img src="${url}" class="media-thumb" onclick="openLightbox('${url}', 'img')">`;
            else if (d.fileType.startsWith('video/')) div.innerHTML = `<video src="${url}" class="media-thumb" onclick="openLightbox('${url}', 'video')"></video>`;
            else div.innerHTML = `<a href="${url}" download="${d.fileName}" class="file-link">üìé ${d.fileName}</a>`;
            b.appendChild(div); b.scrollTop = b.scrollHeight;
        }

        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function notifyUser(t) {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            if(t === 'msg') {
                o.frequency.setValueAtTime(600, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                o.start(); o.stop(audioCtx.currentTime + 0.5);
            } else if(t === 'ring') {
                o.type = 'triangle'; o.frequency.setValueAtTime(400, audioCtx.currentTime);
                o.start(); ringOsc = {osc: o, gain: g};
                window.ringInterval = setInterval(() => {
                    const nt = audioCtx.createOscillator(); const ng = audioCtx.createGain();
                    nt.connect(ng); ng.connect(audioCtx.destination);
                    nt.frequency.setValueAtTime(440, audioCtx.currentTime);
                    ng.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                    nt.start(); nt.stop(audioCtx.currentTime + 0.5);
                }, 1500);
            }
        }

        function stopNotification() {
            clearInterval(window.ringInterval);
            if(ringOsc) { ringOsc.osc.stop(); ringOsc=null; }
        }

        function openLightbox(url, type) {
            document.getElementById('lightbox-modal').style.display = 'flex';
            document.getElementById('lightbox-content').innerHTML = type === 'img' ? `<img src="${url}" id="lightbox-img">` : `<video src="${url}" controls autoplay id="lightbox-video"></video>`;
        }
        function closeLightbox() { document.getElementById('lightbox-modal').style.display = 'none'; }
        function exitChat() { if(confirm("ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü")) window.close(); }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø¹Ù… ÙÙ†ÙŠ - Ø¹ØµØ§Ù…</title>
    
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0088cc; --bg: #e5ddd5; --white: #ffffff; --green: #25d366; --red: #ff3b30; --msg-me: #dcf8c6; --dark: #333; }
        body { font-family: 'Tajawal', sans-serif; margin: 0; background: #f0f2f5; height: 100vh; overflow: hidden; display: flex; justify-content: center; }

        .screen { width: 100%; max-width: 500px; height: 100%; background: var(--bg); display: none; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .active-screen { display: flex; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen { background: var(--white); justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .login-box { width: 100%; }
        input { width: 80%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-family: inherit; font-size: 16px; transition: 0.3s; }
        #password-field { display: none; border: 2px solid var(--red); background-color: #fff0f0; }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; margin: 5px; font-family: inherit; width: 85%; }
        .btn-primary { background: var(--primary); }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { background: var(--primary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 60px; box-sizing: border-box; }
        .user-info { display: flex; flex-direction: column; align-items: flex-start; }
        .user-name { font-weight: bold; font-size: 1.1em; }
        .user-status { font-size: 0.75em; opacity: 0.9; }

        .controls-area { display: flex; align-items: center; gap: 8px; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ */
        .call-btn { background: none; border: none; color: white; font-size: 1.3em; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .call-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) */
        #my-cam-btn { 
            font-size: 1.1em; 
            border: 1px solid white; 
            background: rgba(255,0,0,0.5); /* Ø£Ø­Ù…Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            display: none; /* Ù…Ø®ÙÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ */
        }
        .cam-on { background: var(--green) !important; border-color: var(--green) !important; }

        /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ */
        .logout-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 0.8em; display: none; }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ */
        .btn-active-call { background-color: var(--red) !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); } }

        /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (Ø´Ø§Øª - ÙÙŠØ¯ÙŠÙˆ - Ù†ÙˆØ§ÙØ°) */
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg-me { background: var(--msg-me); align-self: flex-end; border-bottom-left-radius: 0; }
        .msg-other { background: var(--white); align-self: flex-start; border-bottom-right-radius: 0; }
        .sys-msg { align-self: center; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 20px; font-size: 0.8em; color: #555; margin: 5px 0; text-align: center; }
        .media-thumb { max-width: 200px; max-height: 150px; border-radius: 10px; margin-top: 5px; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); }
        .file-link { display: flex; align-items: center; text-decoration: none; color: #333; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 10px; margin-top: 5px; }
        .chat-footer { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .chat-footer input { margin: 0; flex: 1; border: none; padding: 12px; border-radius: 20px; }
        .attach-btn { font-size: 1.5em; cursor: pointer; color: #555; padding: 0 10px; }

        #incoming-modal, #video-modal, #lightbox-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; }
        #incoming-modal { background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; color: white; }
        #video-modal { background: black; }
        #lightbox-modal { background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 200; }
        
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 140px; background: #333; border: 2px solid white; border-radius: 10px; object-fit: cover; transform: scaleX(-1); }
        
        #lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #lightbox-video { max-width: 100%; max-height: 100%; }
        .close-lightbox { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 201; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .incoming-actions { margin-top: 50px; display: flex; gap: 40px; }
        .action-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; color: white; border: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active-screen">
        <div class="login-box">
            <h2 style="color: var(--primary);">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¹ØµØ§Ù…</h2>
            <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
            <input type="text" id="my-name-input" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…..." onkeyup="checkSecretName(this)">
            <input type="password" id="password-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-primary" onclick="handleLoginBtn()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div class="header">
            <div class="user-info">
                <div class="user-name" id="chat-header-name">Ø¹ØµØ§Ù…</div>
                <div class="user-status" id="connection-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
            </div>
            
            <div class="controls-area">
                <button class="call-btn" id="btn-audio" onclick="toggleCall('audio')">ğŸ“</button>
                <button class="call-btn" id="btn-video" onclick="toggleCall('video')">ğŸ“¹</button>
                
                <button class="call-btn" id="my-cam-btn" onclick="toggleMyCam()" title="ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ“·</button>
                
                <button id="logout-btn" class="logout-btn" onclick="logoutAdmin()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
        <div class="chat-body" id="chat-box"></div>
        <div class="chat-footer">
            <span class="attach-btn" onclick="document.getElementById('file-input').click()">ğŸ“</span>
            <input type="file" id="file-input" hidden onchange="sendFile(this)">
            <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendText()">
            <button class="btn btn-primary" style="margin:0; width: auto; border-radius: 50%; padding: 12px 15px;" onclick="sendText()">â¤</button>
        </div>
    </div>

    <div id="incoming-modal">
        <div style="font-size:50px; margin-bottom:20px">ğŸ“²</div>
        <h3 id="incoming-caller-name">Ø´Ø®Øµ Ù…Ø§</h3>
        <p>ÙŠØªØµÙ„ Ø¨Ùƒ...</p>
        <div class="incoming-actions">
            <button class="action-btn" style="background: var(--red);" onclick="rejectCall()">âœ–</button>
            <button class="action-btn" style="background: var(--green);" onclick="acceptCall()">âœ”</button>
        </div>
    </div>
    <div id="video-modal">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <button class="action-btn" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:var(--red);" onclick="endCurrentCall()">ğŸ“</button>
    </div>
    <div id="lightbox-modal">
        <div class="close-lightbox" onclick="closeLightbox()">âœ–</div>
        <div id="lightbox-content"></div>
    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ---
        const ADMIN_ID = "Essam-Host-Secure-ID-9988"; 
        const PASS_HASH = "61e54cf8a83c5f8b3d779b1766f82dd7e678dac5ab3a8ea856509757bbba5d3f"; // Essam.1972
        const SECRET_NAMES = ["Ø¹ØµØ§Ù…", "admin", "Admin", "essam"];
        
        let peer, conn, myName;
        let callObject = null, localStream = null, isCallActive = false, incomingReq = null;
        let audioCtx = null, ringOsc = null;
        
        // Ø­Ø§Ù„Ø© ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù…ØºÙ„Ù‚Ø© = false)
        let myCamEnabled = false; 

        window.onload = function() {
            const savedAdmin = localStorage.getItem('is_essam_admin_v2');
            if (savedAdmin === 'true') { myName = "Ø¹ØµØ§Ù…"; startApp(true); }
        };

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØªØ­ÙƒÙ… ---
        function toggleMyCam() {
            myCamEnabled = !myCamEnabled; // Ù‚Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            updateCamBtnUI();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø§Ø±ÙŠØ©ØŒ Ù†Ø·Ø¨Ù‚ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹
            if(localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if(videoTrack) videoTrack.enabled = myCamEnabled;
            }
        }

        function updateCamBtnUI() {
            const btn = document.getElementById('my-cam-btn');
            if(myCamEnabled) {
                btn.classList.add('cam-on'); // Ø£Ø®Ø¶Ø±
                btn.innerHTML = "ğŸ“·"; // ÙƒØ§Ù…ÙŠØ±Ø§
            } else {
                btn.classList.remove('cam-on'); // Ø£Ø­Ù…Ø±
                btn.innerHTML = "ğŸš«"; // Ù…ØºÙ„Ù‚
            }
        }

        // --- Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… ---
        function checkSecretName(input) {
            const val = input.value.trim();
            const passField = document.getElementById('password-field');
            if (SECRET_NAMES.includes(val)) { passField.style.display = 'block'; passField.focus(); } else { passField.style.display = 'none'; }
        }

        function handleLoginBtn() {
            const nameInput = document.getElementById('my-name-input');
            const passInput = document.getElementById('password-field');
            myName = nameInput.value;
            if (!myName) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");

            if (passInput.style.display === 'block') {
                const inputHash = CryptoJS.SHA256(passInput.value).toString();
                if (inputHash === PASS_HASH) {
                    localStorage.setItem('is_essam_admin_v2', 'true'); 
                    startApp(true);
                } else { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!"); }
            } else { startApp(false); }
        }

        function logoutAdmin() {
            if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.removeItem('is_essam_admin_v2'); location.reload(); }
        }

        function startApp(isHost) {
            initAudio();
            if (isHost) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠØ±
                document.getElementById('logout-btn').style.display = 'block';
                document.getElementById('my-cam-btn').style.display = 'flex'; 
                updateCamBtnUI(); // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ø²Ø±
                document.getElementById('chat-header-name').innerText = "Ù„ÙˆØ­Ø© Ø¹ØµØ§Ù…";
                
                peer = new Peer(ADMIN_ID);
                showScreen('chat-screen');
                document.getElementById('connection-status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...";
                addSystemMessage("Ø£Ù‡Ù„Ø§Ù‹ Ø¹ØµØ§Ù…. Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØºÙ„Ù‚Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹.");
            } else {
                // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø§ ÙŠØ±Ù‰ Ø²Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ„Ø§ Ø§Ù„Ø®Ø±ÙˆØ¬
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('my-cam-btn').style.display = 'none';
                
                peer = new Peer(); 
                showScreen('chat-screen');
                document.getElementById('connection-status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
                peer.on('open', () => { connectToAdmin(); });
            }
            setupPeerEvents(isHost);
        }

        function setupPeerEvents(isHost) {
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') { if (isHost) { alert("Ø¹ØµØ§Ù… Ù…ØªØµÙ„ Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±!"); localStorage.removeItem('is_essam_admin_v2'); location.reload(); } }
                else if (err.type === 'peer-unavailable') { document.getElementById('connection-status').innerText = "Ø¹ØµØ§Ù… ØºÙŠØ± Ù…ØªØ§Ø­ âŒ"; addSystemMessage("Ø¹ØµØ§Ù… ØºÙŠØ± Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹."); }
            });
            peer.on('open', (id) => { if(isHost) document.getElementById('connection-status').innerText = "Ø£Ù†Øª Ø§Ù„Ù…Ø¯ÙŠØ± âœ…"; });
            peer.on('connection', (c) => { conn = c; setupConnection(isHost); });
            peer.on('call', (call) => { handleIncomingCall(call); });
        }

        function connectToAdmin() { conn = peer.connect(ADMIN_ID, { metadata: { name: myName } }); setupConnection(false); }
        function setupConnection(isHost) { conn.on('open', () => { document.getElementById('connection-status').innerText = "Ù…ØªØµÙ„ âœ…"; if(conn.metadata && conn.metadata.name) { updateHeaderName(conn.metadata.name); notifyUser('msg'); addSystemMessage(isHost ? `Ø¯Ø®Ù„ ${conn.metadata.name}` : "ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹ØµØ§Ù…"); } else { conn.send({ type: 'name-handshake', name: myName }); } }); conn.on('data', (data) => { if(typeof data === 'string') { addMessage(data, 'other'); notifyUser('msg'); } else if (data.type === 'name-handshake') { updateHeaderName(data.name); notifyUser('msg'); addSystemMessage(`Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±: ${data.name}`); } else if (data.type === 'file') { const blob = new Blob([new Uint8Array(data.file)], { type: data.fileType }); renderFileMessage({ file: blob, fileType: data.fileType, fileName: data.fileName }, 'other'); notifyUser('msg'); } else if (data.type === 'call-end') { endCurrentCall(false); } }); conn.on('close', () => { document.getElementById('connection-status').innerText = "Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ"; }); }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        function updateHeaderName(name) { document.getElementById('chat-header-name').innerText = name; }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id).classList.add('active-screen'); }
        function sendText() { const txt = document.getElementById('msg-input').value; if(!txt || !conn) return; conn.send(txt); addMessage(txt, 'me'); document.getElementById('msg-input').value = ''; }
        function addMessage(content, source) { const box = document.getElementById('chat-box'); const div = document.createElement('div'); div.className = `message ${source === 'me' ? 'msg-me' : 'msg-other'}`; div.innerText = content; box.appendChild(div); box.scrollTop = box.scrollHeight; }
        function addSystemMessage(txt) { const box = document.getElementById('chat-box'); const div = document.createElement('div'); div.className = 'sys-msg'; div.innerText = txt; box.appendChild(div); box.scrollTop = box.scrollHeight; }
        function sendFile(input) { const file = input.files[0]; if (!file || !conn) return; const reader = new FileReader(); reader.onload = (e) => { const buffer = e.target.result; conn.send({ type: 'file', file: buffer, fileName: file.name, fileType: file.type }); const blob = new Blob([buffer], { type: file.type }); renderFileMessage({ file: blob, fileType: file.type, fileName: file.name }, 'me'); }; reader.readAsArrayBuffer(file); input.value = ''; }
        function renderFileMessage(data, source) { const box = document.getElementById('chat-box'); const div = document.createElement('div'); div.className = `message ${source === 'me' ? 'msg-me' : 'msg-other'}`; const url = URL.createObjectURL(data.file); if (data.fileType.startsWith('image/')) { div.innerHTML = `<img src="${url}" class="media-thumb" onclick="openLightbox('${url}', 'img')">`; } else if (data.fileType.startsWith('video/')) { div.innerHTML = `<video src="${url}" class="media-thumb" onclick="openLightbox('${url}', 'video')"></video>`; } else { div.innerHTML = `<a href="${url}" download="${data.fileName}" class="file-link">ğŸ“ ${data.fileName}</a>`; } box.appendChild(div); box.scrollTop = box.scrollHeight; }
        function openLightbox(url, type) { const modal = document.getElementById('lightbox-modal'); const content = document.getElementById('lightbox-content'); modal.style.display = 'flex'; if(type === 'img') content.innerHTML = `<img src="${url}" id="lightbox-img">`; else content.innerHTML = `<video src="${url}" controls autoplay id="lightbox-video"></video>`; }
        function closeLightbox() { document.getElementById('lightbox-modal').style.display = 'none'; document.getElementById('lightbox-content').innerHTML = ''; }
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(audioCtx.state === 'suspended') audioCtx.resume(); }
        function notifyUser(type) { if(!audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); if (type === 'msg') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5); osc.start(); osc.stop(audioCtx.currentTime + 0.5); if(navigator.vibrate) navigator.vibrate(200); } else if (type === 'ring') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); gain.gain.setValueAtTime(0.5, audioCtx.currentTime); osc.start(); ringOsc = { osc: osc, gain: gain }; if(window.ringInterval) clearInterval(window.ringInterval); window.ringInterval = setInterval(() => { if(audioCtx.state === 'running') { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(440, audioCtx.currentTime); g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5); o.start(); o.stop(audioCtx.currentTime + 0.5); } }, 1500); if(navigator.vibrate) navigator.vibrate([500, 200, 500]); } }
        function stopNotification() { if(window.ringInterval) clearInterval(window.ringInterval); if(ringOsc) { try{ ringOsc.osc.stop(); }catch(e){} ringOsc=null; } if(navigator.vibrate) navigator.vibrate(0); }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ù…Ø¹Ø¯Ù„) ---
        function toggleCall(type) { if (isCallActive) { if (confirm("Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©ØŸ")) endCurrentCall(true); } else startCall(type); }

        function startCall(type) {
            if(!conn) return alert("Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±");
            
            // Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø·Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ ÙˆÙ„ÙƒÙ† Ù†ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ù…ØºÙ„Ù‚Ø©/Ù…ÙØªÙˆØ­Ø©) ÙÙˆØ±Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ù‡Ùˆ Ø§Ù„Ù…ØªØµÙ„ ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØºÙ„Ù‚Ø© -> Ù†ØºÙ„Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø¯ÙŠÙ‡
                // Ø§Ù„Ø¹Ù…ÙŠÙ„: Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø²Ø± ØªØ­ÙƒÙ…ØŒ ÙØ¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙØªÙˆØ­Ø© (myCamEnabled ØªÙƒÙˆÙ† false Ø¹Ù†Ø¯Ù‡ Ù„ÙƒÙ†Ù‡ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø²Ø± Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ù‡Ø§ØŒ Ø³Ù†Ø¹Ø§Ù„Ø¬Ù‡Ø§)
                
                // Ù…Ù„Ø§Ø­Ø¸Ø©: myCamEnabled Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
                // Ù„Ù„Ø¹Ù…ÙŠÙ„: Ù†Ø±ÙŠØ¯Ù‡Ø§ Ø¯Ø§Ø¦Ù…Ø§ true. Ù„Ù„Ù…Ø¯ÙŠØ±: Ø­Ø³Ø¨ Ø§Ù„Ø²Ø±.
                // Ø§Ù„Ø­Ù„: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø²Ø± Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ø§Ù„Ø¹Ù…ÙŠÙ„)ØŒ Ù†Ø¹ØªØ¨Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙØªÙˆØ­Ø©.
                const hasCamBtn = document.getElementById('my-cam-btn').style.display !== 'none';
                
                if(hasCamBtn) {
                    // Ø£Ù†Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±: Ø·Ø¨Ù‚ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
                    localStream.getVideoTracks()[0].enabled = myCamEnabled;
                } else {
                    // Ø£Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…ÙØªÙˆØ­Ø©
                    localStream.getVideoTracks()[0].enabled = true;
                }

                if(type === 'video') {
                    document.getElementById('video-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                }
                
                const call = peer.call(conn.peer, stream, { metadata: { type: type, name: myName } });
                handleCallStream(call);
                setCallActiveState(true, type);
            });
        }

        function handleIncomingCall(call) { incomingReq = call; document.getElementById('incoming-modal').style.display = 'flex'; document.getElementById('incoming-caller-name').innerText = (call.metadata && call.metadata.name) ? call.metadata.name : "Ù…Ø¬Ù‡ÙˆÙ„"; notifyUser('ring'); }

        function acceptCall() {
            stopNotification();
            document.getElementById('incoming-modal').style.display = 'none';
            const isVideo = incomingReq.metadata.type === 'video';
            
            navigator.mediaDevices.getUserMedia({video: isVideo, audio: true}).then(stream => {
                localStream = stream;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ Ø£ÙŠØ¶Ø§Ù‹
                const hasCamBtn = document.getElementById('my-cam-btn').style.display !== 'none';
                if(hasCamBtn && isVideo) {
                    localStream.getVideoTracks()[0].enabled = myCamEnabled;
                }

                incomingReq.answer(stream);
                if(isVideo) {
                    document.getElementById('video-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                }
                handleCallStream(incomingReq);
                setCallActiveState(true, incomingReq.metadata.type);
            });
        }

        function handleCallStream(call) { callObject = call; call.on('stream', remoteStream => { if(document.getElementById('video-modal').style.display === 'block') { document.getElementById('remote-video').srcObject = remoteStream; } else { const audio = new Audio(); audio.srcObject = remoteStream; audio.play(); } }); call.on('close', () => endCurrentCall(false)); }
        function endCurrentCall(notify = true) { if(callObject) callObject.close(); if(localStream) localStream.getTracks().forEach(t => t.stop()); document.getElementById('video-modal').style.display = 'none'; setCallActiveState(false); if(notify && conn) conn.send({type: 'call-end'}); }
        function setCallActiveState(active, type) { isCallActive = active; const btnAudio = document.getElementById('btn-audio'); const btnVideo = document.getElementById('btn-video'); btnAudio.classList.remove('btn-active-call'); btnVideo.classList.remove('btn-active-call'); if(active) { if(type === 'audio') btnAudio.classList.add('btn-active-call'); if(type === 'video') btnVideo.classList.add('btn-active-call'); } }
    </script>
</body>
</html>
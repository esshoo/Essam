<!doctype html>
<html lang="ar" dir="rtl">
<head>
<title>Essam Support • Room</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b1220" />
<link rel="icon" href="icons/icon-192.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">غرفة التواصل</h1>
        <div class="small" id="roomMeta">جارِ التحقق…</div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnEnableNotifs">تفعيل الإشعارات</button>
      <button class="btn" id="btnMic">Mic</button>
      <button class="btn" id="btnCam">Cam</button>
      <button class="btn danger" id="btnLeave">مغادرة</button>
    </div>
  </div>

  <div class="video-grid">
    <div class="card">
      <div class="title">الفيديو</div>
      <div class="small">قد يحتاج WebRTC إلى اتصال مناسب (شبكات الشركات قد تمنع).</div>
      <hr/>
      <div class="video-box"><video id="localVideo" autoplay playsinline muted></video></div>
      <div style="height:10px"></div>
      <div class="video-box"><video id="remoteVideo" autoplay playsinline></video></div>
    </div>

    <div class="card chat">
      <div class="title">الشات</div>
      <div class="small">الرسائل داخل الغرفة (DataChannel).</div>
      <hr/>
      <div class="chatlog" id="chatlog"></div>
      <div class="row">
        <input class="input" id="chatInput" placeholder="اكتب رسالة..." />
        <button class="btn primary" id="btnSend">إرسال</button>
      </div>
      <div class="row">
        <input class="input" type="file" id="fileInput" />
        <button class="btn" id="btnSendFile">إرسال ملف</button>
      </div>
      <div class="small">ملاحظة: إرسال ملفات كبيرة قد يفشل على بعض الشبكات. (يمكن تحسينه بالتقسيم لاحقاً)</div>
    </div>
  </div>

  <div class="footer">الحماية: لا يمكن الدخول إلا بتوكن صحيح وكونك مشاركاً في الغرفة.</div>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<script type="module">
  import { requireAuth } from "./assets/auth.js";
  import { getRequest, getRoom, setMyPeerId, listenPeerIds } from "./assets/db.js";
  import { toast, sanitizeId } from "./assets/ui.js";
  import { initMessaging, wireNotificationButton } from "./assets/notifications.js";

  const params = new URLSearchParams(location.search);
  const roomId = (params.get("room")||"").trim();
  const token = (params.get("token")||"").trim();

  const roomMeta = document.getElementById("roomMeta");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const btnMic = document.getElementById("btnMic");
  const btnCam = document.getElementById("btnCam");
  const btnLeave = document.getElementById("btnLeave");

  const chatlog = document.getElementById("chatlog");
  const chatInput = document.getElementById("chatInput");
  const btnSend = document.getElementById("btnSend");
  const fileInput = document.getElementById("fileInput");
  const btnSendFile = document.getElementById("btnSendFile");

  const user = await requireAuth("index.html");

  await initMessaging();
  wireNotificationButton("#btnEnableNotifs");

  if(!roomId || !token){
    toast("رابط غير صحيح", "الرجاء فتح الرابط من داخل الطلب.");
    location.href="index.html";
  }

  const room = await getRoom(roomId);
  if(!room || !room.participants || room.participants[user.uid] !== true){
    toast("غير مصرح", "أنت لست مشاركاً في هذه الغرفة.");
    location.href="index.html";
  }
  const req = await getRequest(room.requestId);
  if(!req || req.roomToken !== token || req.roomId !== roomId){
    toast("توكن غير صحيح", "لا يمكن الدخول.");
    location.href="index.html";
  }
  roomMeta.textContent = `Room: ${roomId} • أنت: ${user.displayName || user.email || user.uid}`;

  let localStream = null;
  let micOn = true;
  let camOn = true;

  async function getMedia(){
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
    localVideo.srcObject = localStream;
  }

  await getMedia().catch(e=>{
    console.error(e);
    toast("تعذّر الوصول للكاميرا/المايك", "يمكنك المحاولة من إعدادات المتصفح.");
  });

  const myPeerId = sanitizeId(`room_${roomId}_${user.uid}`);
  const peer = new window.Peer(myPeerId);
  await setMyPeerId(roomId, user.uid, myPeerId);

  let conn = null;
  let call = null;
  let remotePeerId = null;

  function addMsg(who, text, mine=false){
    const el = document.createElement("div");
    el.className = "msg" + (mine ? " me":"");
    el.innerHTML = `<div class="who"></div><div class="txt"></div>`;
    el.querySelector(".who").textContent = who;
    el.querySelector(".txt").textContent = text;
    chatlog.appendChild(el);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  peer.on("connection", (c)=>{
    conn = c;
    hookConn();
  });

  peer.on("call", (incoming)=>{
    call = incoming;
    call.answer(localStream);
    call.on("stream", (s)=> remoteVideo.srcObject = s);
  });

  function hookConn(){
    if(!conn) return;
    conn.on("open", ()=> addMsg("system", "تم الاتصال بالطرف الآخر."));
    conn.on("data", (data)=>{
      if(data?.type === "text") addMsg("other", data.text||"");
      if(data?.type === "file") {
        const blob = new Blob([data.buffer], {type: data.mime || "application/octet-stream"});
        const url = URL.createObjectURL(blob);
        addMsg("other", `ملف: ${data.name} (اضغط للتحميل)`);
        const a = document.createElement("a");
        a.href = url; a.download = data.name || "file";
        a.textContent = "تحميل الملف";
        a.style.display="inline-block";
        a.style.margin="6px 0";
        chatlog.appendChild(a);
        chatlog.scrollTop = chatlog.scrollHeight;
        setTimeout(()=> URL.revokeObjectURL(url), 60_000);
      }
    });
  }

  listenPeerIds(roomId, (peerIds)=>{
    const entries = Object.entries(peerIds||{});
    const other = entries.find(([uid,pid])=> uid !== user.uid);
    if(other && !remotePeerId){
      remotePeerId = other[1];
      conn = peer.connect(remotePeerId);
      hookConn();
      if(localStream){
        call = peer.call(remotePeerId, localStream);
        call.on("stream", (s)=> remoteVideo.srcObject = s);
      }
    }
  });

  btnSend.addEventListener("click", ()=>{
    const t = (chatInput.value||"").trim();
    if(!t) return;
    if(conn && conn.open){
      conn.send({type:"text", text:t});
      addMsg("me", t, true);
      chatInput.value="";
    }else{
      toast("غير متصل", "انتظر اتصال الطرف الآخر.");
    }
  });

  btnSendFile.addEventListener("click", async ()=>{
    const f = fileInput.files?.[0];
    if(!f) return;
    if(!(conn && conn.open)) return toast("غير متصل","انتظر اتصال الطرف الآخر.");
    if(f.size > 8*1024*1024) return toast("الملف كبير", "الحد الحالي 8MB (يمكن زيادة لاحقاً مع التقسيم).");
    const buf = await f.arrayBuffer();
    conn.send({type:"file", name:f.name, mime:f.type, buffer:buf});
    addMsg("me", `تم إرسال ملف: ${f.name}`, true);
    fileInput.value="";
  });

  btnMic.addEventListener("click", ()=>{
    micOn = !micOn;
    if(localStream) localStream.getAudioTracks().forEach(t=> t.enabled = micOn);
    btnMic.textContent = micOn ? "Mic" : "Mic Off";
  });

  btnCam.addEventListener("click", ()=>{
    camOn = !camOn;
    if(localStream) localStream.getVideoTracks().forEach(t=> t.enabled = camOn);
    btnCam.textContent = camOn ? "Cam" : "Cam Off";
  });

  btnLeave.addEventListener("click", ()=>{
    try{ peer.destroy(); }catch{}
    try{ localStream?.getTracks().forEach(t=>t.stop()); }catch{}
    location.href = "index.html";
  });
</script>
</body>
</html>

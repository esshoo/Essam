<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Essam Support â€¢ Video</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <meta name="theme-color" content="#0b1220" />
  <style>
    .vwrap{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    video{width:100%; background:#000; border-radius:14px; min-height:240px;}
    .bar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0;}
    .status{font-size:13px; opacity:.85}
    @media (max-width: 900px){ .vwrap{grid-template-columns:1fr;} }
  </style>

  <!-- âœ… PeerJS library (Ù„Ø§Ø²Ù… Ù‚Ø¨Ù„ Ø£ÙŠ ÙƒÙˆØ¯ ÙŠØ³ØªØ®Ø¯Ù… Peer) -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">ØºØ±ÙØ© Ø§Ù„ØªÙˆØ§ØµÙ„</h1>
        <div class="small" id="who"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn danger" id="btnLeave">Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>
  </div>

  <div class="card">
    <div class="bar">
      <div class="status" id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦</div>
      <div class="status" id="roomInfo"></div>
    </div>
    <div class="vwrap">
      <div>
        <div class="small">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø£Ù†Øª)</div>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>
      <div>
        <div class="small">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</div>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <div class="bar" style="margin-top:12px">
      <button class="btn" id="btnCam">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button class="btn" id="btnMic">ÙƒØªÙ… Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
      <button class="btn" id="btnRetry">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  </div>

  <div class="footer">Ù„Ùˆ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±: Ø§ÙØªØ­ Ø§Ù„Ø·Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØºØ±ÙØ© ÙˆØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª rooms/peerIds ÙÙŠ Rules.</div>
</div>

<script type="module">
  import { requireAuth } from "./assets/auth.js";
  import { setMyPeerId, listenPeerIds } from "./assets/db.js";
  import { db, ref, get } from "./assets/firebase.js";

  const who = document.getElementById("who");
  const statusEl = document.getElementById("status");
  const roomInfo = document.getElementById("roomInfo");

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  const btnLeave = document.getElementById("btnLeave");
  const btnCam = document.getElementById("btnCam");
  const btnMic = document.getElementById("btnMic");
  const btnRetry = document.getElementById("btnRetry");

  const qs = new URLSearchParams(location.search);
  const roomId = qs.get("room") || "";
  const token = qs.get("token") || "";

  function setStatus(t){ statusEl.textContent = t; }
  function fatal(msg){
    setStatus("âŒ " + msg);
    throw new Error(msg);
  }

  if(!roomId || !token){
    fatal("Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­ (room/token). Ø§Ø±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨.");
  }

  // âœ… Ù„Ø§Ø²Ù… Auth
  const user = await requireAuth("index.html");
  who.textContent = `${user.displayName || user.email || user.uid} â€¢ UID: ${user.uid}`;
  roomInfo.textContent = `Room: ${roomId}`;

  // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† (roomId Ø¹Ù†Ø¯Ùƒ = reqId)
  const reqSnap = await get(ref(db, `requests/${roomId}`));
  if(!reqSnap.exists()) fatal("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
  const req = reqSnap.val();
  if(String(req.roomToken || "") !== String(token)) fatal("Token ØºÙŠØ± ØµØ­ÙŠØ­.");

  // âœ… ØªØ­Ø¶ÙŠØ± Media
  let localStream = null;
  async function ensureMedia(){
    if(localStream) return localStream;
    setStatus("ğŸ¥ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒâ€¦");
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localVideo.srcObject = localStream;
    return localStream;
  }

  // âœ… PeerJS
  if(!window.Peer){
    fatal("PeerJS Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø­Ø¬Ø¨.");
  }

  let peer = null;
  let myPeerId = "";
  let currentCall = null;
  let connectedTo = ""; // other peerId
  let unsubPeerIds = null;
  let peerReady = false;
  let pendingPeerMap = null;

  function cleanupCall(){
    try{ currentCall?.close(); }catch{}
    currentCall = null;
    connectedTo = "";
    remoteVideo.srcObject = null;
  }

  function attachPeerHandlersOnce(){
    if(!peer || peer.__handlersAttached) return;
    peer.__handlersAttached = true;

    peer.on("call", async (call) => {
      try{
        setStatus("ğŸ“ Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯â€¦");
        const stream = await ensureMedia();
        cleanupCall();
        currentCall = call;

        call.on("stream", (remoteStream) => {
          remoteVideo.srcObject = remoteStream;
          setStatus("âœ… Ù…ØªØµÙ„ (Inbound)");
        });

        call.on("close", () => {
          setStatus("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„.");
          cleanupCall();
        });

        call.on("error", (e) => {
          console.error(e);
          setStatus("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.");
        });

        call.answer(stream);
      }catch(e){
        console.error(e);
        setStatus("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„.");
      }
    });

    peer.on("disconnected", () => setStatus("âš ï¸ ØªÙ… ÙØµÙ„ Peerâ€¦"));
    peer.on("error", (e) => {
      console.error(e);
      setStatus("âš ï¸ Peer Error: " + (e?.type || e?.message || "unknown"));
    });
  }

  async function startPeer(){
    setStatus("ğŸ”Œ Ø¥Ù†Ø´Ø§Ø¡ Peerâ€¦");
    peer = new Peer(undefined, { debug: 2 });

    attachPeerHandlersOnce();

    await new Promise((resolve, reject)=>{
      peer.on("open", async (id)=>{
        try{
          myPeerId = id;
          peerReady = true;
          setStatus("âœ… Peer Ø¬Ø§Ù‡Ø²: " + id);

          // âœ… Ø³Ø¬Ù„ peerId ÙÙŠ RTDB (Ø¯Ù‡ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø¨ÙŠØªØ³Ø¨Ø¨ permission_denied Ù‚Ø¨Ù„ ØªØ¹Ø¯ÙŠÙ„ rules)
          await setMyPeerId(roomId, user.uid, id);

          // Ù„Ùˆ ÙˆØµÙ„ØªÙ†Ø§ peerIds Ù‚Ø¨Ù„ Ù…Ø§ peer ÙŠØ¨Ù‚Ù‰ Ø¬Ø§Ù‡Ø²
          if(pendingPeerMap){
            handlePeerMap(pendingPeerMap);
            pendingPeerMap = null;
          }

          resolve();
        }catch(e){
          reject(e);
        }
      });
    });
  }

  async function callPeer(otherPeerId){
    if(!peerReady || !peer) return;
    if(!otherPeerId) return;
    if(connectedTo === otherPeerId) return;

    try{
      const stream = await ensureMedia();
      setStatus("ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±â€¦");
      cleanupCall();

      connectedTo = otherPeerId;
      const call = peer.call(otherPeerId, stream);
      currentCall = call;

      call.on("stream", (remoteStream)=>{
        remoteVideo.srcObject = remoteStream;
        setStatus("âœ… Ù…ØªØµÙ„ (Outbound)");
      });
      call.on("close", ()=>{
        setStatus("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„.");
        cleanupCall();
      });
      call.on("error", (e)=>{
        console.error(e);
        setStatus("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„.");
      });
    }catch(e){
      console.error(e);
      setStatus("âš ï¸ ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„.");
    }
  }

  function pickOtherPeerId(map){
    // map: { uid: peerId, ... } Ø­Ø³Ø¨ db.js
    const entries = Object.entries(map || {});
    for(const [uid, pid] of entries){
      if(uid !== user.uid && pid) return pid;
    }
    return "";
  }

  function handlePeerMap(map){
    // âš ï¸ Ù…Ù‡Ù…: Ù‚Ø¨Ù„ Ù…Ø§ peer ÙŠØ¨Ù‚Ù‰ Ø¬Ø§Ù‡Ø²ØŒ Ù…Ø§ Ù†Ù†Ø§Ø¯ÙŠØ´ peer.on/peer.call
    if(!peerReady || !peer){
      pendingPeerMap = map;
      return;
    }
    const other = pickOtherPeerId(map);
    if(other) callPeer(other);
    else setStatus("âŒ› ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±â€¦");
  }

  function startPeerIdsListener(){
    if(unsubPeerIds) try{ unsubPeerIds(); }catch{}
    unsubPeerIds = listenPeerIds(roomId, (map)=>{
      handlePeerMap(map);
    });
  }

  // ===== UI Buttons =====
  btnLeave.addEventListener("click", ()=>{
    try{
      cleanupCall();
      peer?.destroy();
      localStream?.getTracks()?.forEach(t=>t.stop());
    }catch{}
    location.replace("index.html");
  });

  btnCam.addEventListener("click", ()=>{
    if(!localStream) return;
    const v = localStream.getVideoTracks()[0];
    if(!v) return;
    v.enabled = !v.enabled;
    btnCam.textContent = v.enabled ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§" : "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
  });

  btnMic.addEventListener("click", ()=>{
    if(!localStream) return;
    const a = localStream.getAudioTracks()[0];
    if(!a) return;
    a.enabled = !a.enabled;
    btnMic.textContent = a.enabled ? "ÙƒØªÙ… Ø§Ù„Ù…Ø§ÙŠÙƒ" : "ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ";
  });

  btnRetry.addEventListener("click", async ()=>{
    setStatus("ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©â€¦");
    try{
      cleanupCall();
      peer?.destroy();
      peerReady = false;
      peer = null;
      await startPeer();
    }catch(e){
      console.error(e);
      setStatus("âš ï¸ ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
    }
  });

  // ===== Boot =====
  setStatus("â³ Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„â€¦");
  await ensureMedia();
  await startPeer();
  startPeerIdsListener();
</script>
</body>
</html>

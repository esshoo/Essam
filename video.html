<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Essam Support â€¢ Room</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="stylesheet" href="assets/styles.css" />

  <!-- PeerJS (Ù†ÙØ³ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>

  <style>
    .layout{display:grid; grid-template-columns: 360px 1fr; gap:12px;}
    .side{position:sticky; top:12px; height:calc(100vh - 24px); display:flex; flex-direction:column; gap:12px;}
    .videos{display:grid; grid-template-columns:1fr; gap:10px;}
    video{width:100%; background:#000; border-radius:14px; min-height:190px;}
    .vlabel{font-size:12px; opacity:.85; margin-bottom:6px}
    .chat{display:flex; flex-direction:column; height:calc(100vh - 24px);}
    .chatlog{flex:1; overflow:auto; padding:10px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08)}
    .msg{padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.06); margin:8px 0; border:1px solid rgba(255,255,255,.06)}
    .msg.me{background:rgba(120,210,255,.12); border-color:rgba(120,210,255,.18)}
    .msg.system{background:rgba(255,209,139,.10); border-color:rgba(255,209,139,.20)}
    .who{font-size:12px; opacity:.85; margin-bottom:6px}
    .inputRow{display:flex; gap:10px; margin-top:10px; align-items:center}
    .inputRow .input{flex:1}
    .fileRow{display:flex; gap:10px; align-items:center; margin-top:10px}
    .pill{font-size:12px; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10)}
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;}
      .side{position:relative; height:auto}
      .chat{height:auto}
      .chatlog{height:420px}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 class="h1">ØºØ±ÙØ© Ø§Ù„ØªÙˆØ§ØµÙ„</h1>
        <div class="small" id="hdr"></div>
      </div>
    </div>
    <div class="row">
      <span class="pill" id="status">...</span>
      <button class="btn" id="btnHangup">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
      <button class="btn danger" id="btnEnd">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>
  </div>

  <div class="layout">
    <div class="side">
      <div class="card">
        <div class="title">Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>
        <div class="small" id="roomInfo"></div>
        <hr/>
        <div class="videos">
          <div>
            <div class="vlabel" id="meLabel">Ø£Ù†Øª</div>
            <video id="localVideo" autoplay playsinline muted></video>
          </div>
          <div>
            <div class="vlabel" id="otherLabel">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</div>
            <video id="remoteVideo" autoplay playsinline></video>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnCallAudio">Ø§ØªØµØ§Ù„ ØµÙˆØª</button>
          <button class="btn" id="btnCallVideo">Ø§ØªØµØ§Ù„ ÙÙŠØ¯ÙŠÙˆ</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnMic">ÙƒØªÙ… Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
          <button class="btn" id="btnCam">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        </div>
      </div>

      <div class="card">
        <div class="title">Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„ÙØ§Øª</div>
        <div class="small">ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ/Ø£ÙŠ Ù…Ù„Ù (Ø¹Ø¨Ø± PeerJS DataChannel)</div>
        <hr/>
        <div class="fileRow">
          <input type="file" id="fileInput" class="input" />
          <button class="btn" id="btnSendFile">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
        <div class="small" id="fileHint" style="margin-top:10px; opacity:.8">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ù‚Ø¯ ØªÙØ´Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¨ÙƒØ©.</div>
      </div>
    </div>

    <div class="chat">
      <div class="card" style="flex:1">
        <div class="title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
        <div class="small">Ø±Ø³Ø§Ø¦Ù„ ÙÙˆØ±ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© (Ù„ÙŠØ³Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ†)</div>
        <hr/>
        <div class="chatlog" id="chatLog"></div>
        <div class="inputRow">
          <input class="input" id="chatText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
          <button class="btn primary" id="btnSend">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØµÙ„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±: Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØºØ±ÙØ© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø±ÙÙŠÙ†. Ø§Ù„Ù€ Peer ID Ù‡Ù†Ø§ Ø«Ø§Ø¨Øª Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</div>
</div>

<script type="module">
  import { requireAuth } from "./assets/auth.js";
  import { isAdmin, closeRequestAsAdmin, listenRequest } from "./assets/db.js";
  import { db, ref, get } from "./assets/firebase.js";
  import { toast } from "./assets/ui.js";
  import { notifyLocal } from "./assets/notifications.js";
  import { primeAudio, beep, pop, errorBeep } from "./assets/sounds.js";

  const qs = new URLSearchParams(location.search);
  const roomId = qs.get("room") || "";
  const token = qs.get("token") || "";

  const hdr = document.getElementById("hdr");
  const statusEl = document.getElementById("status");
  const btnHangup = document.getElementById("btnHangup");
  const roomInfo = document.getElementById("roomInfo");
  const meLabel = document.getElementById("meLabel");
  const otherLabel = document.getElementById("otherLabel");

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  const btnEnd = document.getElementById("btnEnd");

  window.addEventListener("pointerdown", () => primeAudio(), { once:true });
  const btnCallAudio = document.getElementById("btnCallAudio");
  const btnCallVideo = document.getElementById("btnCallVideo");
  const btnMic = document.getElementById("btnMic");
  const btnCam = document.getElementById("btnCam");

  const chatLog = document.getElementById("chatLog");
  const chatText = document.getElementById("chatText");
  const btnSend = document.getElementById("btnSend");

  const fileInput = document.getElementById("fileInput");
  const btnSendFile = document.getElementById("btnSendFile");

  function setStatus(t){ statusEl.textContent = t; }
  function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function addMsg({ who, text, kind="msg" }){
    const div = document.createElement("div");
    div.className = `msg ${kind}`;
    div.innerHTML = `<div class="who">${escapeHtml(who)}</div><div>${text}</div>`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function redirectBack(user, admin){
    if(admin) return location.replace("admin.html");
    return location.replace(user.isAnonymous ? "guest.html" : "client.html");
  }

  if(!roomId || !token){
    toast("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­", "Ø§Ø±Ø¬Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨");
    location.replace("index.html");
  }

  // 1) Auth
  const user = await requireAuth("index.html");
  const admin = await isAdmin(user.uid, user.email || "");

  // 2) Validate request/token
  const snap = await get(ref(db, `requests/${roomId}`));
  if(!snap.exists()){
    toast("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    redirectBack(user, admin);
  }
  const req = snap.val();
  if(String(req.roomToken||"") !== String(token)){
    toast("Token ØºÙŠØ± ØµØ­ÙŠØ­", "Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù†ØªÙ‡Øª");
    redirectBack(user, admin);
  }
  if(String(req.status||"") !== "accepted"){
    toast("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©", `Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${req.status||"â€”"}`);
    redirectBack(user, admin);
  }

  const clientName = (req.displayName || req.email || req.createdByUid || "Client");
  const adminName = (user.displayName || user.email || "Admin");
  const myName = admin ? adminName : (user.displayName || user.email || clientName || "User");
  const otherName = admin ? clientName : "Ø§Ù„Ø¯Ø¹Ù…";

  hdr.textContent = `${admin ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ù…ÙŠÙ„"} â€¢ ${myName}`;
  roomInfo.textContent = `Room: ${roomId}`;
  meLabel.textContent = `Ø£Ù†Øª (${myName})`;
  otherLabel.textContent = `Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (${otherName})`;

  // Listen for request state changes (close, revoke token, etc.)
  listenRequest(roomId, (r)=>{
    if(!r) return;
    if(r.status === "closed" || r.status === "ended" || !r.roomToken){
      addMsg({ who: "Ø§Ù„Ù†Ø¸Ø§Ù…", text: "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.", kind: "system" });
      setTimeout(()=>redirectBack(user, admin), 600);
    }
  });

  // 3) PeerJS stable IDs (Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
  if(!window.Peer){
    toast("PeerJS ØºÙŠØ± Ù…ØªØ§Ø­", "ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø­Ø¬Ø¨ cdnjs");
    redirectBack(user, admin);
  }

  const cleanRoom = String(roomId).replace(/[^a-zA-Z0-9]/g, "").slice(0, 32) || "room";
  const myPeerId = (admin ? "admin_" : "client_") + cleanRoom;
  const otherPeerId = (admin ? "client_" : "admin_") + cleanRoom;

  let peer = null;
  let conn = null;
  let call = null;
  let localStream = null;
  let micMuted = false;
  let camOff = false;

  async function ensureMedia({ video }){
    if(localStream){
      // if we only had audio before and now want video, try upgrade
      const hasVideo = localStream.getVideoTracks().some(t=>t.readyState === "live");
      if(video && !hasVideo){
        localStream.getTracks().forEach(t=>t.stop());
        localStream = null;
      }
    }
    if(!localStream){
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video: !!video });
      localVideo.srcObject = localStream;
    }
    return localStream;
  }

  function closeCall(){
    try{ call?.close(); }catch{}
    call = null;
    remoteVideo.srcObject = null;
  }

  function closeConn(){
    try{ conn?.close(); }catch{}
    conn = null;
  }

  function system(text){ addMsg({ who: "Ø§Ù„Ù†Ø¸Ø§Ù…", text: escapeHtml(text), kind:"system"}); }

  async function endSession(reason="ended"){
    try{
      // notify other
      try{ conn?.send({ type:"session-end", reason }); }catch{}
      closeCall();
      closeConn();
      try{ peer?.disconnect(); peer?.destroy(); }catch{}

      if(admin){
        // admin seals the session in DB so link becomes invalid
        await closeRequestAsAdmin({ reqId: roomId, adminUid: user.uid, reason });
      }
    }catch(e){
      console.error(e);
    }
  }


  btnHangup.addEventListener("click", ()=>{
    try{
      if(call){ call.close(); call = null; }
      // keep data-channel open for chat/files
      if(localStream){
        localStream.getTracks().forEach(t=> t.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      system("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ù…ÙˆØ§ØµÙ„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø£Ùˆ Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©.");
      beep();
    }catch(e){
      console.error(e);
    }
  });

  btnEnd.addEventListener("click", async ()=>{
    btnEnd.disabled = true;
    system("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©...");
    await endSession("left");
    redirectBack(user, admin);
  });

  btnMic.addEventListener("click", ()=>{
    if(!localStream) return;
    micMuted = !micMuted;
    localStream.getAudioTracks().forEach(t=>t.enabled = !micMuted);
    btnMic.textContent = micMuted ? "Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ…" : "ÙƒØªÙ… Ø§Ù„Ù…Ø§ÙŠÙƒ";
  });

  btnCam.addEventListener("click", ()=>{
    if(!localStream) return;
    camOff = !camOff;
    localStream.getVideoTracks().forEach(t=>t.enabled = !camOff);
    btnCam.textContent = camOff ? "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§" : "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
  });

  function setupConn(c){
    conn = c;
    setStatus("âœ… Ù…ØªØµÙ„");
    system("ØªÙ… Ø§ØªØµØ§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    conn.on("open", ()=>{
      try{ conn.send({ type:"hello", name: myName, isAdmin: admin }); }catch{}
    });

    conn.on("data", async (data)=>{
      try{
        if(!data || typeof data !== "object") return;
        if(data.type === "hello"){
          const n = data.name || otherName;
          otherLabel.textContent = `Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (${n})`;
          system(`Ø§ØªØµÙ„: ${n}`);
          pop();
          notifyLocal("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„", `ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${n}`, location.href);
          return;
        }
        if(data.type === "chat"){
          addMsg({ who: data.name || otherName, text: escapeHtml(data.text), kind:"" });
          beep();
          notifyLocal("Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©", (data.text||"").slice(0,120), location.href);
          return;
        }
        if(data.type === "file"){
          const name = data.name || "file";
          const mime = data.mime || "application/octet-stream";
          const buf = data.buf;
          const blob = new Blob([buf], { type: mime });
          const url = URL.createObjectURL(blob);
          const safe = escapeHtml(name);
          addMsg({
            who: data.from || otherName,
            text: `<a class="btn" href="${url}" download="${safe}">ØªØ­Ù…ÙŠÙ„: ${safe}</a>`,
            kind:""
          });
          return;
        }
        if(data.type === "session-end"){
          system("Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£Ù†Ù‡Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø©.");
          errorBeep();
          notifyLocal("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©", "Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£Ù†Ù‡Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø©", location.href);
          await endSession("peer-ended");
          redirectBack(user, admin);
          return;
        }
      }catch(e){
        console.error(e);
      }
    });

    conn.on("close", async ()=>{
      setStatus("âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„");
      system("ØªÙ… ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„");
      errorBeep();
      notifyLocal("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„", "ØªÙ… ÙØµÙ„ Ø§Ù„Ø§ØªØµØ§Ù„", location.href);
      closeCall();
      if(admin){
        // Ù„Ùˆ Ø§Ù†Ù‚Ø·Ø¹ Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ù‡Ø§Ø¡ØŒ Ø§Ù‚ÙÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·
        await closeRequestAsAdmin({ reqId: roomId, adminUid: user.uid, reason: "disconnect" }).catch(()=>{});
      }
    });

    conn.on("error", (e)=>{
      console.error(e);
      setStatus("âš ï¸ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„");
    });
  }

  function setupPeer(){
    setStatus("â³ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„...");
    peer = new Peer(myPeerId, { debug: 2 });

    peer.on("open", ()=>{
      setStatus("âŒ› ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±...");
      system(`Peer Ready: ${myPeerId}`);

      // admin ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙŠØ¶Ø§Ù‹ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
      if(admin){
        connectWithRetry();
      }else{
        // Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†ØŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ­Ø§ÙˆÙ„ Ø¨Ø±Ø¶Ùˆ Ù„Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø§ Ø§ØªØµÙ„Ø´
        setTimeout(()=>{ if(!conn) connectWithRetry(); }, 2000);
      }
    });

    peer.on("connection", (c)=>{
      system("Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯...");
      setupConn(c);
    });

    peer.on("call", async (incoming)=>{
      try{
        // âœ… Ù„Ø§ ØªÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…ÙƒØ§Ù„Ù…Ø©
        // ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²Ø± (Ø§ØªØµØ§Ù„ ÙÙŠØ¯ÙŠÙˆ)
        const wantsVideo = false;
        const stream = await ensureMedia({ video: wantsVideo });
        closeCall();
        call = incoming;
        incoming.answer(stream);
        incoming.on("stream", (rs)=>{ remoteVideo.srcObject = rs; setStatus("âœ… Ù…ØªØµÙ„ (Call)"); });
        incoming.on("close", ()=>{ system("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©"); closeCall(); });
        incoming.on("error", (e)=>{ console.error(e); system("Ø®Ø·Ø£ Ù…ÙƒØ§Ù„Ù…Ø©"); });
      }catch(e){
        console.error(e);
        system("ØªØ¹Ø°Ø± Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
      }
    });

    peer.on("error", (e)=>{
      console.error(e);
      setStatus("âš ï¸ Peer Error");
      system(e?.type || e?.message || "peer error");
    });
  }

  function connectWithRetry(){
    let tries = 0;
    const maxTries = 25;

    const tick = ()=>{
      tries++;
      if(conn && conn.open) return;
      if(tries > maxTries){
        setStatus("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„");
        system("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ÙØªØ­ Ù†ÙØ³ Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©.");
        return;
      }

      try{
        setStatus("ğŸ“¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ØªØµØ§Ù„...");
        const c = peer.connect(otherPeerId, { reliable: true });
        c.on("open", ()=> setupConn(c));
        c.on("error", ()=>{ setTimeout(tick, 800); });
      }catch{
        setTimeout(tick, 800);
      }
    };

    tick();
  }

  async function startCall(video){
    if(!conn || !conn.open){
      toast("ØºÙŠØ± Ù…ØªØµÙ„", "Ø§Ù†ØªØ¸Ø± Ø§ØªØµØ§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }
    try{
      const stream = await ensureMedia({ video });
      closeCall();
      call = peer.call(otherPeerId, stream);
      call.on("stream", (rs)=>{ remoteVideo.srcObject = rs; setStatus("âœ… Ù…ØªØµÙ„ (Call)"); });
      call.on("close", ()=>{ system("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©"); closeCall(); });
      call.on("error", (e)=>{ console.error(e); system("Ø®Ø·Ø£ Ù…ÙƒØ§Ù„Ù…Ø©"); });
    }catch(e){
      console.error(e);
      toast("ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©", e?.message || "");
    }
  }

  btnCallAudio.addEventListener("click", ()=> startCall(false));
  btnCallVideo.addEventListener("click", ()=> startCall(true));

  function sendChat(){
    const t = (chatText.value||"").trim();
    if(!t) return;
    if(!conn || !conn.open){
      toast("ØºÙŠØ± Ù…ØªØµÙ„", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª");
      return;
    }
    conn.send({ type:"chat", name: myName, text: t });
    addMsg({ who: myName, text: escapeHtml(t), kind:"me" });
    chatText.value = "";
  }

  btnSend.addEventListener("click", sendChat);
  chatText.addEventListener("keydown", (e)=>{ if(e.key === "Enter") sendChat(); });

  btnSendFile.addEventListener("click", async ()=>{
    if(!conn || !conn.open){
      toast("ØºÙŠØ± Ù…ØªØµÙ„", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª");
      return;
    }
    const f = fileInput.files && fileInput.files[0];
    if(!f){ toast("Ø§Ø®ØªØ± Ù…Ù„Ù", ""); return; }

    btnSendFile.disabled = true;
    try{
      const buf = await f.arrayBuffer();
      conn.send({ type:"file", from: myName, name: f.name, mime: f.type || "application/octet-stream", buf });
      addMsg({ who: myName, text: `ğŸ“ ${escapeHtml(f.name)}`, kind:"me" });
      fileInput.value = "";
    }catch(e){
      console.error(e);
      toast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù", e?.message || "");
    }finally{
      btnSendFile.disabled = false;
    }
  });

  // Start
  system(`Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„... (${admin ? "admin" : "client"})`);
  setupPeer();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØºØ±ÙØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0088cc; --bg: #e5ddd5; --white: #ffffff; --green: #25d366; --red: #ff3b30; --msg-me: #dcf8c6; --dark: #333; }
        body { font-family: 'Tajawal', sans-serif; margin: 0; background: #f0f2f5; height: 100vh; overflow: hidden; display: flex; justify-content: center; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { background: var(--primary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 60px; box-sizing: border-box; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: bold; font-size: 1.1em; }
        .user-status { font-size: 0.75em; opacity: 0.9; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls-area { display: flex; align-items: center; gap: 8px; }
        .call-btn { background: none; border: none; color: white; font-size: 1.3em; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .call-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) */
        #my-cam-btn { font-size: 1.1em; border: 1px solid white; background: rgba(255,0,0,0.5); display: none; }
        .cam-on { background: var(--green) !important; border-color: var(--green) !important; }
        
        /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ */
        .logout-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 0.8em; }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù†Ø´Ø· */
        .btn-active-call { background-color: var(--red) !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); } }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª */
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: soft-light; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg-me { background: var(--msg-me); align-self: flex-end; border-bottom-left-radius: 0; }
        .msg-other { background: var(--white); align-self: flex-start; border-bottom-right-radius: 0; }
        .sys-msg { align-self: center; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; font-size: 0.8em; color: white; margin: 5px 0; text-align: center; }
        
        /* Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
        .media-thumb { max-width: 200px; max-height: 150px; border-radius: 10px; margin-top: 5px; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); }
        .file-link { display: flex; align-items: center; text-decoration: none; color: #333; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 10px; margin-top: 5px; }

        /* Ø§Ù„ÙÙˆØªØ± (Ø§Ù„ÙƒØªØ§Ø¨Ø©) */
        .chat-footer { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .chat-footer input { margin: 0; flex: 1; border: none; padding: 12px; border-radius: 20px; outline: none; }
        .attach-btn { font-size: 1.5em; cursor: pointer; color: #555; padding: 0 10px; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (ÙÙŠØ¯ÙŠÙˆ - Ø§ØªØµØ§Ù„) */
        #incoming-modal, #video-modal, #lightbox-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; }
        #incoming-modal { background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; color: white; }
        #video-modal { background: black; }
        #lightbox-modal { background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 200; }
        
        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 140px; background: #333; border: 2px solid white; border-radius: 10px; object-fit: cover; transform: scaleX(-1); }
        
        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶ (Lightbox) */
        #lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #lightbox-video { max-width: 100%; max-height: 100%; }
        .close-lightbox { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 201; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        
        .incoming-actions { margin-top: 50px; display: flex; gap: 40px; }
        .action-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; color: white; border: none; }
    </style>
</head>
<body>

    <div id="chat-screen" class="screen">
        <div class="header">
            <div class="user-info">
                <div class="user-name" id="chat-header-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="user-status" id="connection-status">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
            </div>
            
            <div class="controls-area">
                <button class="call-btn" id="btn-audio" onclick="toggleCall('audio')">ğŸ“</button>
                <button class="call-btn" id="btn-video" onclick="toggleCall('video')">ğŸ“¹</button>
                
                <button class="call-btn" id="my-cam-btn" onclick="toggleMyCam()" title="ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸš«</button>
                
                <button class="logout-btn" onclick="exitChat()">Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>
        </div>

        <div class="chat-body" id="chat-box"></div>

        <div class="chat-footer">
            <span class="attach-btn" onclick="document.getElementById('file-input').click()">ğŸ“</span>
            <input type="file" id="file-input" hidden onchange="sendFile(this)">
            <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendText()">
            <button class="send-btn" onclick="sendText()">â¤</button>
        </div>
    </div>

    <div id="incoming-modal">
        <div style="font-size:50px; margin-bottom:20px">ğŸ“²</div>
        <h3 id="incoming-caller-name">Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯...</h3>
        <p>ÙŠØ±ØºØ¨ ÙÙŠ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹Ùƒ</p>
        <div class="incoming-actions">
            <button class="action-btn" style="background: var(--red);" onclick="rejectCall()">âœ–</button>
            <button class="action-btn" style="background: var(--green);" onclick="acceptCall()">âœ”</button>
        </div>
    </div>

    <div id="video-modal">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <button class="action-btn" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:var(--red);" onclick="endCurrentCall()">ğŸ“</button>
    </div>

    <div id="lightbox-modal">
        <div class="close-lightbox" onclick="closeLightbox()">âœ–</div>
        <div id="lightbox-content"></div>
    </div>

    <script>
        // --- 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø­Ø±ÙŠ) ---
        const urlParams = new URLSearchParams(window.location.search);
        const ROOM_ID = urlParams.get('room');
        const ROLE = urlParams.get('role'); // admin OR client
        let MY_NAME = urlParams.get('name') || "Ù…Ø³ØªØ®Ø¯Ù…";

        if (!ROOM_ID || !ROLE) {
            alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­! ÙŠØ¬Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.");
            window.location.href = 'index.html';
        }

        // --- 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‡ÙˆÙŠØ© ---
        // admin-ROOM123 ÙŠØªØµÙ„ Ø¨Ù€ client-ROOM123
        const myPeerId = `${ROLE}-${ROOM_ID}`;
        const targetPeerId = ROLE === 'admin' ? `client-${ROOM_ID}` : `admin-${ROOM_ID}`;
        const displayName = ROLE === 'admin' ? "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹ØµØ§Ù…" : MY_NAME;

        let peer, conn;
        let callObject = null, localStream = null, isCallActive = false, incomingReq = null;
        let audioCtx = null, ringOsc = null;
        let myCamEnabled = false; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØºÙ„Ù‚Ø©

        // --- 3. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
        window.onload = function() {
            initUI();
            startPeerConnection();
            initAudio(); // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        };

        function initUI() {
            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            if (ROLE === 'admin') {
                document.getElementById('my-cam-btn').style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                document.getElementById('chat-header-name').innerText = MY_NAME; // Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
                updateCamBtnUI();
            } else {
                document.getElementById('chat-header-name').innerText = "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹ØµØ§Ù…";
                document.getElementById('my-cam-btn').style.display = 'none';
                myCamEnabled = true; // Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒØ§Ù…ÙŠØ±ØªÙ‡ Ù…ÙØªÙˆØ­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
            }
        }

        function startPeerConnection() {
            document.getElementById('connection-status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...";
            peer = new Peer(myPeerId);

            peer.on('open', (id) => {
                document.getElementById('connection-status').innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© âœ…";
                
                // Ø¥Ø°Ø§ Ø£Ù†Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ Ø³Ø£Ø¨Ø§Ø¯Ø± Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„
                if (ROLE === 'admin') {
                    connectToTarget();
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'peer-unavailable') {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ùˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ Ù„Ø³Ù‡ Ø¨ÙŠÙØªØ­
                    if(ROLE === 'admin') setTimeout(connectToTarget, 2000);
                } else if (err.type === 'unavailable-id') {
                    alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±!");
                }
            });

            peer.on('connection', (c) => { handleDataConnection(c); });
            peer.on('call', (call) => { handleIncomingCall(call); });
        }

        // Ø¯Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ø´Ø§Øª)
        function connectToTarget() {
            document.getElementById('connection-status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±...";
            // Ù†Ø±Ø³Ù„ Ø§Ø³Ù…Ù†Ø§ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const c = peer.connect(targetPeerId, { metadata: { name: displayName } });
            handleDataConnection(c);
        }

        function handleDataConnection(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('connection-status').innerText = "Ù…ØªØµÙ„ âœ…";
                // Ø¥Ø°Ø§ Ø£Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø£Ø±Ø³Ù„ Ø§Ø³Ù…ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±
                if (ROLE === 'client') {
                    conn.send({ type: 'name-handshake', name: displayName });
                }
                notifyUser('msg');
            });

            conn.on('data', (data) => {
                if(typeof data === 'string') {
                    addMessage(data, 'other');
                    notifyUser('msg');
                } else if (data.type === 'name-handshake') {
                    document.getElementById('chat-header-name').innerText = data.name;
                    addSystemMessage(`Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ${data.name}`);
                } else if (data.type === 'file') {
                    const blob = new Blob([new Uint8Array(data.file)], { type: data.fileType });
                    renderFileMessage({ file: blob, fileType: data.fileType, fileName: data.fileName }, 'other');
                    notifyUser('msg');
                } else if (data.type === 'call-end') {
                    endCurrentCall(false);
                }
            });

            conn.on('close', () => {
                document.getElementById('connection-status').innerText = "Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ";
                addSystemMessage("Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ØºØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©");
            });
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ù…Ø¯ÙŠØ±) ---
        function toggleMyCam() {
            myCamEnabled = !myCamEnabled;
            updateCamBtnUI();
            if(localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if(videoTrack) videoTrack.enabled = myCamEnabled;
            }
        }

        function updateCamBtnUI() {
            const btn = document.getElementById('my-cam-btn');
            if(myCamEnabled) {
                btn.classList.add('cam-on');
                btn.innerHTML = "ğŸ“·"; // Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙƒØ§Ù…ÙŠØ±Ø§
            } else {
                btn.classList.remove('cam-on');
                btn.innerHTML = "ğŸš«"; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ù…Ù†ÙˆØ¹
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ (ÙÙŠØ¯ÙŠÙˆ / ØµÙˆØª) ---
        function toggleCall(type) {
            if (isCallActive) {
                if (confirm("Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) endCurrentCall(true);
            } else {
                startCall(type);
            }
        }

        function startCall(type) {
            if(!conn || !conn.open) return alert("Ø§Ù†ØªØ¸Ø± Ø§ØªØµØ§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙ„Ø§Ù‹");
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ù„Ù„Ù…Ø¯ÙŠØ±)
                if (ROLE === 'admin') {
                    localStream.getVideoTracks()[0].enabled = myCamEnabled;
                }

                if(type === 'video') {
                    document.getElementById('video-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                }
                
                const call = peer.call(targetPeerId, stream, { metadata: { type: type, name: displayName } });
                handleCallStream(call);
                setCallActiveState(true, type);
            }).catch(err => alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ: " + err));
        }

        function handleIncomingCall(call) {
            incomingReq = call;
            document.getElementById('incoming-modal').style.display = 'flex';
            document.getElementById('incoming-caller-name').innerText = (call.metadata && call.metadata.name) ? call.metadata.name : "Ù…ØªØµÙ„";
            notifyUser('ring');
        }

        function acceptCall() {
            stopNotification();
            document.getElementById('incoming-modal').style.display = 'none';
            const isVideo = incomingReq.metadata.type === 'video';
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ù„Ù„Ù…Ø¯ÙŠØ±)
                if (ROLE === 'admin') {
                    localStream.getVideoTracks()[0].enabled = myCamEnabled;
                }

                incomingReq.answer(stream);
                
                if(isVideo) {
                    document.getElementById('video-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                }
                
                handleCallStream(incomingReq);
                setCallActiveState(true, incomingReq.metadata.type);
            });
        }

        function rejectCall() {
            stopNotification();
            document.getElementById('incoming-modal').style.display = 'none';
            if(incomingReq) incomingReq.close();
            if(conn) conn.send("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
        }

        function handleCallStream(call) {
            callObject = call;
            call.on('stream', remoteStream => {
                if(document.getElementById('video-modal').style.display === 'block') {
                    document.getElementById('remote-video').srcObject = remoteStream;
                } else {
                    // Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ© (Ù†Ù†Ø´Ø¦ Ø¹Ù†ØµØ± ØµÙˆØª Ù…Ø®ÙÙŠ)
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.play();
                }
            });
            call.on('close', () => endCurrentCall(false));
        }

        function endCurrentCall(notify = true) {
            if(callObject) callObject.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-modal').style.display = 'none';
            setCallActiveState(false);
            if(notify && conn) conn.send({type: 'call-end'});
        }

        function setCallActiveState(active, type) {
            isCallActive = active;
            const btnAudio = document.getElementById('btn-audio');
            const btnVideo = document.getElementById('btn-video');
            btnAudio.classList.remove('btn-active-call');
            btnVideo.classList.remove('btn-active-call');
            if(active) {
                if(type === 'audio') btnAudio.classList.add('btn-active-call');
                if(type === 'video') btnVideo.classList.add('btn-active-call');
            }
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        function sendText() {
            const input = document.getElementById('msg-input');
            const txt = input.value;
            if(!txt || !conn) return;
            conn.send(txt);
            addMessage(txt, 'me');
            input.value = '';
        }

        function addMessage(content, source) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `message ${source === 'me' ? 'msg-me' : 'msg-other'}`;
            div.innerText = content;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function addSystemMessage(txt) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = 'sys-msg';
            div.innerText = txt;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function sendFile(input) {
            const file = input.files[0];
            if (!file || !conn) return;
            
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ ÙƒÙ€ Buffer
            const reader = new FileReader();
            reader.onload = (e) => {
                const buffer = e.target.result;
                conn.send({ type: 'file', file: buffer, fileName: file.name, fileType: file.type });
                
                const blob = new Blob([buffer], { type: file.type });
                renderFileMessage({ file: blob, fileType: file.type, fileName: file.name }, 'me');
            };
            reader.readAsArrayBuffer(file);
            input.value = '';
        }

        function renderFileMessage(data, source) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `message ${source === 'me' ? 'msg-me' : 'msg-other'}`;
            
            const url = URL.createObjectURL(data.file);
            
            if (data.fileType.startsWith('image/')) {
                div.innerHTML = `<img src="${url}" class="media-thumb" onclick="openLightbox('${url}', 'img')">`;
            } else if (data.fileType.startsWith('video/')) {
                div.innerHTML = `<video src="${url}" class="media-thumb" onclick="openLightbox('${url}', 'video')"></video>`;
            } else {
                div.innerHTML = `<a href="${url}" download="${data.fileName}" class="file-link">ğŸ“ ${data.fileName}</a>`;
            }
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        
        function notifyUser(type) {
            if(!audioCtx) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'msg') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'ring') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                osc.start();
                ringOsc = { osc: osc, gain: gain };
                
                // Ø±Ù†ÙŠÙ† Ù…ØªÙ‚Ø·Ø¹
                if(window.ringInterval) clearInterval(window.ringInterval);
                window.ringInterval = setInterval(() => {
                    if(audioCtx.state === 'running') {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination);
                        o.frequency.setValueAtTime(440, audioCtx.currentTime);
                        g.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                        o.start(); o.stop(audioCtx.currentTime + 0.5);
                    }
                }, 1500);
            }
        }

        function stopNotification() {
            if(window.ringInterval) clearInterval(window.ringInterval);
            if(ringOsc) { try{ ringOsc.osc.stop(); }catch(e){} ringOsc=null; }
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø±Ø¶ (Lightbox) ---
        function openLightbox(url, type) {
            const modal = document.getElementById('lightbox-modal');
            const content = document.getElementById('lightbox-content');
            modal.style.display = 'flex';
            if(type === 'img') content.innerHTML = `<img src="${url}" id="lightbox-img">`;
            else content.innerHTML = `<video src="${url}" controls autoplay id="lightbox-video"></video>`;
        }
        function closeLightbox() {
            document.getElementById('lightbox-modal').style.display = 'none';
            document.getElementById('lightbox-content').innerHTML = '';
        }

        function exitChat() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) window.close();
        }
    </script>
</body>
</html>
